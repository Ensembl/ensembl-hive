<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ensembl-hive: Bio::EnsEMBL::Hive::Scheduler Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ensembl-hive
   &#160;<span id="projectnumber">2.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">Bio::EnsEMBL::Hive::Scheduler Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a8bd3190564f0e48f010e1a88650d5e41"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a> ()</td></tr>
<tr class="separator:a8bd3190564f0e48f010e1a88650d5e41"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a65f7b429d0ffbda238faeda2451350a8"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a65f7b429d0ffbda238faeda2451350a8">schedule_workers_resync_if_necessary</a> ()</td></tr>
<tr class="separator:a65f7b429d0ffbda238faeda2451350a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9d2af12ce052ca879c543465c6477da1"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a9d2af12ce052ca879c543465c6477da1">suggest_analysis_to_specialize_a_worker</a> ()</td></tr>
<tr class="separator:a9d2af12ce052ca879c543465c6477da1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad37b01e88608cec39e5f883d95c8ea42"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#ad37b01e88608cec39e5f883d95c8ea42">schedule_workers</a> ()</td></tr>
<tr class="separator:ad37b01e88608cec39e5f883d95c8ea42"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a235921067a5147f198099ba00b85acd2"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a235921067a5147f198099ba00b85acd2">sort_pairs_by_suitability</a> ()</td></tr>
<tr class="separator:a235921067a5147f198099ba00b85acd2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><h1><a class="anchor" id="Description"></a>
Description</h1>
 <pre>
    Scheduler starts with the numbers of required workers for unblocked analyses,
    then goes through several kinds of restrictions (submit_limit, meadow_limits, hive_capacity, etc)
    that act as limiters and may cap the original numbers in several ways.
    The capped numbers are then grouped by meadow_type and rc_name and returned in a two-level hash.

</pre> </div><h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="ad37b01e88608cec39e5f883d95c8ea42"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public Bio::EnsEMBL::Hive::Scheduler::schedule_workers </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-schedule_workers" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-schedule_workers-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-schedule_workers-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-schedule_workers-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#ad37b01e88608cec39e5f883d95c8ea42">schedule_workers</a> {</div>
<div class="line">    my ($queen, $submit_capacity, $default_meadow_type, $list_of_analyses, $meadow_capacity_limiter_hashed_by_type, $analysis_id2rc_name) = @_;</div>
<div class="line"></div>
<div class="line">    my @workers_to_submit_by_analysis               = ();   # The down-to-analysis <span class="stringliteral">&quot;plan&quot;</span> that may completely change by the time the Workers are born and specialized</div>
<div class="line">    my %workers_to_submit_by_meadow_type_rc_name    = ();   # Pre-pending-adjusted per-resource breakout</div>
<div class="line">    my $total_extra_workers_required                = 0;</div>
<div class="line">    my ($pairs_sorted_by_suitability, $log_buffer)  = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a235921067a5147f198099ba00b85acd2">Bio::EnsEMBL::Hive::Scheduler::sort_pairs_by_suitability</a>( $list_of_analyses );</div>
<div class="line"></div>
<div class="line">    unless( @$pairs_sorted_by_suitability ) {</div>
<div class="line"></div>
<div class="line">        unless( @$log_buffer ) {</div>
<div class="line">            push @$log_buffer, <span class="stringliteral">&quot;Could not find any suitable analyses to start scheduling.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">        my $submit_capacity_limiter = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_limiter.html">Bio::EnsEMBL::Hive::Limiter</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_limiter.html#a89203ff40a85e13c7ef840a46dcf4487">new</a>( <span class="stringliteral">&#39;Max number of Workers scheduled this time&#39;</span>, $submit_capacity );</div>
<div class="line">        my $queen_capacity_limiter  = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_limiter.html">Bio::EnsEMBL::Hive::Limiter</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_limiter.html#a89203ff40a85e13c7ef840a46dcf4487">new</a>( <span class="stringliteral">&#39;Total reciprocal capacity of the Hive&#39;</span>, 1.0 - $queen-&gt;db-&gt;get_RoleAdaptor-&gt;get_hive_current_load() );</div>
<div class="line"></div>
<div class="line">        ANALYSIS: <span class="keywordflow">foreach</span> my $pair (@$pairs_sorted_by_suitability) {</div>
<div class="line">            <span class="keywordflow">if</span>( $submit_capacity_limiter-&gt;reached ) {</div>
<div class="line">                <span class="keywordflow">if</span>( $analysis_id2rc_name ) {    # only add <span class="keyword">this</span> message when scheduling and not during a Worker<span class="stringliteral">&#39;s specialization</span></div>
<div class="line"><span class="stringliteral">                    push @$log_buffer, &quot;Submission capacity (=&quot;.$submit_capacity_limiter-&gt;original_capacity.&quot;) has been reached.&quot;;</span></div>
<div class="line"><span class="stringliteral">                }</span></div>
<div class="line"><span class="stringliteral">                last ANALYSIS;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            my ($analysis, $analysis_stats) = @$pair;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            my $logic_name          = $analysis-&gt;logic_name;</span></div>
<div class="line"><span class="stringliteral">            my $this_meadow_type    = $analysis-&gt;meadow_type || $default_meadow_type;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            if( $meadow_capacity_limiter_hashed_by_type &amp;&amp; $meadow_capacity_limiter_hashed_by_type-&gt;{$this_meadow_type}-&gt;reached ) {</span></div>
<div class="line"><span class="stringliteral">                push @$log_buffer, &quot;Available capacity of &#39;</span>$this_meadow_type<span class="stringliteral">&#39; Meadow (=&quot;.$meadow_capacity_limiter_hashed_by_type-&gt;{$this_meadow_type}-&gt;original_capacity.&quot;) has been reached, skipping Analysis &#39;</span>$logic_name<span class="stringliteral">&#39;.&quot;;</span></div>
<div class="line"><span class="stringliteral">                next ANALYSIS;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                #digging deeper under the surface so need to sync:</span></div>
<div class="line"><span class="stringliteral">            if( $analysis_stats-&gt;status =~ /^(LOADING|ALL_CLAIMED|BLOCKED|SYNCHING)$/ ) {</span></div>
<div class="line"><span class="stringliteral">                push @$log_buffer, &quot;Analysis &#39;</span>$logic_name<span class="stringliteral">&#39; is &quot;.$analysis_stats-&gt;status.&quot;, safe-synching it...&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                if( $queen-&gt;safe_synchronize_AnalysisStats($analysis_stats) ) {</span></div>
<div class="line"><span class="stringliteral">                    push @$log_buffer, &quot;Safe-sync of Analysis &#39;</span>$logic_name<span class="stringliteral">&#39; succeeded.&quot;;</span></div>
<div class="line"><span class="stringliteral">                } else {</span></div>
<div class="line"><span class="stringliteral">                    push @$log_buffer, &quot;Safe-sync of Analysis &#39;</span>$logic_name<span class="stringliteral">&#39; could not be run at this moment, skipping it.&quot;;</span></div>
<div class="line"><span class="stringliteral">                    next ANALYSIS;</span></div>
<div class="line"><span class="stringliteral">                }</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">            if( $analysis_stats-&gt;status =~ /^(BLOCKED|SYNCHING)$/ ) {</span></div>
<div class="line"><span class="stringliteral">                push @$log_buffer, &quot;Analysis &#39;</span>$logic_name<span class="stringliteral">&#39; is still &quot;.$analysis_stats-&gt;status.&quot;, skipping it.&quot;;</span></div>
<div class="line"><span class="stringliteral">                next ANALYSIS;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                # getting the initial worker requirement for this analysis (may be off if $analysis_stats has not been sync&#39;</span>ed recently)</div>
<div class="line">            my $extra_workers_this_analysis = $analysis_stats-&gt;estimate_num_required_workers;</div>
<div class="line"></div>
<div class="line">            if ($extra_workers_this_analysis &lt;= 0) {</div>
<div class="line">                push @$log_buffer, <span class="stringliteral">&quot;Analysis &#39;$logic_name&#39; doesn&#39;t require extra workers, skipping it.&quot;</span>;</div>
<div class="line">                next ANALYSIS;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            $total_extra_workers_required += $extra_workers_this_analysis;    # also keep the total number required so far (<span class="keywordflow">if</span> nothing required we may need a resync later)</div>
<div class="line"></div>
<div class="line">                <span class="preprocessor"># setting up all negotiating limiters:</span></div>
<div class="line"><span class="preprocessor"></span>            $queen_capacity_limiter-&gt;multiplier( $analysis_stats-&gt;hive_capacity );</div>
<div class="line">            my @limiters = (</div>
<div class="line">                $submit_capacity_limiter,</div>
<div class="line">                $queen_capacity_limiter,</div>
<div class="line">                $meadow_capacity_limiter_hashed_by_type</div>
<div class="line">                    ? $meadow_capacity_limiter_hashed_by_type-&gt;{$this_meadow_type}</div>
<div class="line">                    : (),</div>
<div class="line">                defined($analysis-&gt;analysis_capacity)</div>
<div class="line">                    ? <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_limiter.html">Bio::EnsEMBL::Hive::Limiter</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_limiter.html#a89203ff40a85e13c7ef840a46dcf4487">new</a>( <span class="stringliteral">&quot;Number of Workers working at &#39;$logic_name&#39; analysis&quot;</span>,</div>
<div class="line">                                                        $analysis-&gt;analysis_capacity - $analysis_stats-&gt;num_running_workers )</div>
<div class="line">                    : (),</div>
<div class="line">            );</div>
<div class="line"></div>
<div class="line">            my $hit_the_limit;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">                # negotiations:</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">foreach</span> my $limiter (@limiters) {</div>
<div class="line">                ($extra_workers_this_analysis, $hit_the_limit) = $limiter-&gt;preliminary_offer( $extra_workers_this_analysis );</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span>($hit_the_limit) {</div>
<div class="line">                    <span class="keywordflow">if</span>($extra_workers_this_analysis&gt;0) {</div>
<div class="line">                        push @$log_buffer, <span class="stringliteral">&quot;Hit the limit of *** &quot;</span>.$limiter-&gt;description.<span class="stringliteral">&quot; ***, settling for $extra_workers_this_analysis Workers.&quot;</span>;</div>
<div class="line">                    } <span class="keywordflow">else</span> {</div>
<div class="line">                        push @$log_buffer, <span class="stringliteral">&quot;Hit the limit of *** &quot;</span>.$limiter-&gt;description.<span class="stringliteral">&quot; ***, skipping this Analysis.&quot;</span>;</div>
<div class="line">                        next ANALYSIS;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">                # let all parties know the final decision of negotiations:</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">foreach</span> my $limiter (@limiters) {</div>
<div class="line">                $limiter-&gt;final_decision( $extra_workers_this_analysis );</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            push @workers_to_submit_by_analysis, [ $analysis, $extra_workers_this_analysis];</div>
<div class="line">            push @$log_buffer, $analysis_stats-&gt;toString;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>($analysis_id2rc_name) {</div>
<div class="line">                my $this_rc_name    = $analysis_id2rc_name-&gt;{ $analysis_stats-&gt;analysis_id };</div>
<div class="line">                $workers_to_submit_by_meadow_type_rc_name{ $this_meadow_type }{ $this_rc_name } += $extra_workers_this_analysis;</div>
<div class="line">                push @$log_buffer, sprintf(<span class="stringliteral">&quot;Before checking the Valley for pending jobs, the Scheduler allocated $extra_workers_this_analysis x $this_meadow_type:$this_rc_name extra workers for &#39;%s&#39; [%.4f hive_load remaining]&quot;</span>,</div>
<div class="line">                                    $logic_name,</div>
<div class="line">                                    $queen_capacity_limiter-&gt;available_capacity,</div>
<div class="line">                                );</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">        }   # /ANALYSIS : <span class="keywordflow">foreach</span> my $pair (@$pairs_sorted_by_suitability)</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> (\@workers_to_submit_by_analysis, \%workers_to_submit_by_meadow_type_rc_name, $total_extra_workers_required, $log_buffer);</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
<a class="anchor" id="a65f7b429d0ffbda238faeda2451350a8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public Bio::EnsEMBL::Hive::Scheduler::schedule_workers_resync_if_necessary </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-schedule_workers_resync_if_necessary" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-schedule_workers_resync_if_necessary-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-schedule_workers_resync_if_necessary-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-schedule_workers_resync_if_necessary-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a65f7b429d0ffbda238faeda2451350a8">schedule_workers_resync_if_necessary</a> {</div>
<div class="line">    my ($queen, $valley, $list_of_analyses) = @_;</div>
<div class="line"></div>
<div class="line">    my $analysis_id2rc_id                       = $queen-&gt;db-&gt;get_AnalysisAdaptor-&gt;fetch_HASHED_FROM_analysis_id_TO_resource_class_id();</div>
<div class="line">    my $rc_id2name                              = $queen-&gt;db-&gt;get_ResourceClassAdaptor-&gt;fetch_HASHED_FROM_resource_class_id_TO_name();</div>
<div class="line">    my $meadow_type_2_name_2_users              = $queen-&gt;meadow_type_2_name_2_users_of_running_workers();</div>
<div class="line"><span class="preprocessor">        # combined mapping:</span></div>
<div class="line"><span class="preprocessor"></span>    my $analysis_id2rc_name                     = { map { $_ =&gt; $rc_id2name-&gt;{ $analysis_id2rc_id-&gt;{ $_ }} } keys %$analysis_id2rc_id };</div>
<div class="line"></div>
<div class="line">    my $submit_capacity                         = $valley-&gt;config_get(<span class="stringliteral">&#39;SubmitWorkersMax&#39;</span>);</div>
<div class="line">    my $default_meadow_type                     = $valley-&gt;get_default_meadow()-&gt;type;</div>
<div class="line">    my ($valley_running_worker_count,</div>
<div class="line">        $meadow_capacity_limiter_hashed_by_type)= $valley-&gt;count_running_workers_and_generate_limiters( $meadow_type_2_name_2_users );</div>
<div class="line"></div>
<div class="line">    my ($workers_to_submit_by_analysis, $workers_to_submit_by_meadow_type_rc_name, $total_extra_workers_required, $log_buffer)</div>
<div class="line">        = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#ad37b01e88608cec39e5f883d95c8ea42">schedule_workers</a>($queen, $submit_capacity, $default_meadow_type, $list_of_analyses, $meadow_capacity_limiter_hashed_by_type, $analysis_id2rc_name);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( $log_buffer );</div>
<div class="line"></div>
<div class="line">    unless( $total_extra_workers_required ) {</div>
<div class="line">        <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;According to analysis_stats no workers are required... let&#39;s see if anything went out of sync.&quot;</span> );</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            # FIXME: here is an (optimistic) assumption all Workers the DB knows about are reachable from the Valley:</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span>( $queen-&gt;db-&gt;get_RoleAdaptor-&gt;count_active_roles() != $valley_running_worker_count ) {</div>
<div class="line">            <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;Mismatch between DB&#39;s active Roles and Valley&#39;s running Workers detected, checking for dead workers...&quot;</span> );</div>
<div class="line">            $queen-&gt;check_for_dead_workers($valley, 1);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;re-synchronizing...&quot;</span> );</div>
<div class="line">        $queen-&gt;synchronize_hive( $list_of_analyses );</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( $queen-&gt;db-&gt;hive_auto_rebalance_semaphores ) {  # make sure rebalancing only ever happens <span class="keywordflow">for</span> the pipelines that asked <span class="keywordflow">for</span> it</div>
<div class="line">            <span class="keywordflow">if</span>( $queen-&gt;check_nothing_to_run_but_semaphored( $list_of_analyses ) ) { # and <span class="keywordtype">double</span>-check on our side</div>
<div class="line">                <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;looks like we may need re-balancing semaphore_counts...&quot;</span> );</div>
<div class="line">                <span class="keywordflow">if</span>( my $rebalanced_jobs_counter = $queen-&gt;db-&gt;get_AnalysisJobAdaptor-&gt;balance_semaphores( $list_of_analyses ) ) {</div>
<div class="line">                    <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;re-balanced $rebalanced_jobs_counter jobs, going through another re-synchronization...&quot;</span> );</div>
<div class="line">                    $queen-&gt;synchronize_hive( $list_of_analyses );</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;hmmm... managed to re-balance 0 jobs, you may need to investigate further.&quot;</span> );</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;apparently there are no semaphored jobs that may need to be re-balanced at this time.&quot;</span> );</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( [ <span class="stringliteral">&quot;automatic re-balancing of semaphore_counts is off by default.&quot;</span>,</div>
<div class="line">                            <span class="stringliteral">&quot;If you think your pipeline might benefit from it, set hive_auto_rebalance_semaphores =&gt; 1 in the PipeConfig&#39;s hive_meta_table.&quot;</span> ] );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ($workers_to_submit_by_analysis, $workers_to_submit_by_meadow_type_rc_name, $total_extra_workers_required, $log_buffer)</div>
<div class="line">            = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#ad37b01e88608cec39e5f883d95c8ea42">schedule_workers</a>($queen, $submit_capacity, $default_meadow_type, $list_of_analyses, $meadow_capacity_limiter_hashed_by_type, $analysis_id2rc_name);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( $log_buffer );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        # adjustment for pending workers:</span></div>
<div class="line"><span class="preprocessor"></span>    my ($pending_worker_counts_by_meadow_type_rc_name, $total_pending_all_meadows)  = $valley-&gt;get_pending_worker_counts_by_meadow_type_rc_name();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span>( my ($this_meadow_type, $partial_workers_to_submit_by_rc_name) = each %$workers_to_submit_by_meadow_type_rc_name) {</div>
<div class="line">        <span class="keywordflow">while</span>( my ($this_rc_name, $workers_to_submit_this_group) = each %$partial_workers_to_submit_by_rc_name) {</div>
<div class="line">            <span class="keywordflow">if</span>(my $pending_this_group = $pending_worker_counts_by_meadow_type_rc_name-&gt;{ $this_meadow_type }{ $this_rc_name }) {</div>
<div class="line"></div>
<div class="line">                <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;The plan was to submit $workers_to_submit_this_group x $this_meadow_type:$this_rc_name workers when the Scheduler detected $pending_this_group pending in this group, &quot;</span> );</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span>( $workers_to_submit_this_group &gt; $pending_this_group) {</div>
<div class="line">                    $workers_to_submit_by_meadow_type_rc_name-&gt;{$this_meadow_type}{$this_rc_name}   -= $pending_this_group; # adjust the hashed value</div>
<div class="line">                    <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;so I recommend submitting only &quot;</span>.$workers_to_submit_by_meadow_type_rc_name-&gt;{$this_meadow_type}{$this_rc_name}.<span class="stringliteral">&quot; extra&quot;</span> );</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    <span class="keyword">delete</span> $workers_to_submit_by_meadow_type_rc_name-&gt;{$this_meadow_type}{$this_rc_name};                   # avoid leaving an empty group in the hash</div>
<div class="line">                    <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;so I don&#39;t recommend submitting any extra&quot;</span> );</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a>( <span class="stringliteral">&quot;I recommend submitting $workers_to_submit_this_group x $this_meadow_type:$this_rc_name workers&quot;</span> );</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        unless(keys %{ $workers_to_submit_by_meadow_type_rc_name-&gt;{$this_meadow_type} }) {  # <span class="keywordflow">if</span> nothing has been scheduled <span class="keywordflow">for</span> a meadow,</div>
<div class="line">            <span class="keyword">delete</span> $workers_to_submit_by_meadow_type_rc_name-&gt;{$this_meadow_type};          # <span class="keywordflow">do</span> not mention the meadow in the hash</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $workers_to_submit_by_meadow_type_rc_name;</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
<a class="anchor" id="a8bd3190564f0e48f010e1a88650d5e41"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public Bio::EnsEMBL::Hive::Scheduler::scheduler_say </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-scheduler_say" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-scheduler_say-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-scheduler_say-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-scheduler_say-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a8bd3190564f0e48f010e1a88650d5e41">scheduler_say</a> {</div>
<div class="line">    my ($msgs) = @_;</div>
<div class="line"></div>
<div class="line">    $msgs = [ $msgs ] unless( ref($msgs) eq <span class="stringliteral">&#39;ARRAY&#39;</span> );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $msg (@$msgs) {</div>
<div class="line">        print <span class="stringliteral">&quot;Scheduler : $msg\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
<a class="anchor" id="a235921067a5147f198099ba00b85acd2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public Bio::EnsEMBL::Hive::Scheduler::sort_pairs_by_suitability </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-sort_pairs_by_suitability" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-sort_pairs_by_suitability-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-sort_pairs_by_suitability-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-sort_pairs_by_suitability-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a235921067a5147f198099ba00b85acd2">sort_pairs_by_suitability</a> {</div>
<div class="line"></div>
<div class="line">    my @sorted_stats    = map { [ $_, $_-&gt;stats] }                  # 3. pair analyses with their stats objects</div>
<div class="line">                            sort { $b-&gt;priority &lt;=&gt; $a-&gt;priority }  # 2. but ordered according to their priority levels</div>
<div class="line">                                shuffle                             # 1. make sure analyses are well mixed within the same priority level</div>
<div class="line">                                    @{ shift @_ };</div>
<div class="line"></div>
<div class="line">    my (@primary_candidates, @secondary_candidates, $discarded_count, @log_buffer);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $pair ( @sorted_stats ) {</div>
<div class="line">        my ($analysis, $stats) = @$pair;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            # assuming sync() is expensive, so first trying analyses that have already been sunk:</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span>( ($stats-&gt;estimate_num_required_workers &gt; 0) and ($stats-&gt;status =~/^(READY|WORKING)$/) ) {</div>
<div class="line"></div>
<div class="line">            push @primary_candidates, $pair;</div>
<div class="line"></div>
<div class="line">        } elsif( $stats-&gt;status =~ /^(LOADING|BLOCKED|ALL_CLAIMED|SYNCHING)$/ ) {</div>
<div class="line"></div>
<div class="line">            push @secondary_candidates, $pair;</div>
<div class="line"></div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">            $discarded_count++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( $discarded_count ) {</div>
<div class="line">        push @log_buffer, <span class="stringliteral">&quot;Discarded $discarded_count analyses because they do not need any Workers.&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ( [@primary_candidates,  @secondary_candidates], \@log_buffer );</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
<a class="anchor" id="a9d2af12ce052ca879c543465c6477da1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public Bio::EnsEMBL::Hive::Scheduler::suggest_analysis_to_specialize_a_worker </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-suggest_analysis_to_specialize_a_worker" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-suggest_analysis_to_specialize_a_worker-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-suggest_analysis_to_specialize_a_worker-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-suggest_analysis_to_specialize_a_worker-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a9d2af12ce052ca879c543465c6477da1">suggest_analysis_to_specialize_a_worker</a> {</div>
<div class="line">    my ( $worker, $analyses_matching_pattern, $analyses_pattern ) = @_;</div>
<div class="line"></div>
<div class="line">    my $queen               = $worker-&gt;adaptor;</div>
<div class="line">    my $worker_rc_id        = $worker-&gt;resource_class_id;</div>
<div class="line">    my $worker_meadow_type  = $worker-&gt;meadow_type;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( ! @$analyses_matching_pattern ) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Could not find any Analyses matching &#39;$analyses_pattern&#39; pattern&quot;</span>;</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">        $worker-&gt;worker_say( <span class="stringliteral">&quot;Found &quot;</span>.scalar(@$analyses_matching_pattern).<span class="stringliteral">&quot; analyses matching &#39;$analyses_pattern&#39; pattern&quot;</span> );</div>
<div class="line"></div>
<div class="line">        my @analyses_matching_worker = grep { !$worker_rc_id or $worker_rc_id==$_-&gt;resource_class_id}</div>
<div class="line">                                        grep { !$worker_meadow_type or !$_-&gt;meadow_type or ($worker_meadow_type eq $_-&gt;meadow_type) }</div>
<div class="line"><span class="preprocessor">                                            # if any other attributes of the worker are specifically constrained in the analysis (such as meadow_name),</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">                                            # the corresponding checks should be added here</span></div>
<div class="line"><span class="preprocessor"></span>                                                @$analyses_matching_pattern;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( !@analyses_matching_worker ) {</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> <span class="stringliteral">&quot;Could not find any of the &quot;</span>.scalar(@$analyses_matching_pattern).<span class="stringliteral">&quot; &#39;$analyses_pattern&#39; Analyses that would suit this Worker&quot;</span>;</div>
<div class="line"></div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">            my ($workers_to_submit_by_analysis, $workers_to_submit_by_meadow_type_rc_name, $total_extra_workers_required, $log_buffer)</div>
<div class="line">                = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#ad37b01e88608cec39e5f883d95c8ea42">schedule_workers</a>( $queen, 1, $worker_meadow_type, \@analyses_matching_worker );</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>( $worker-&gt;debug ) {</div>
<div class="line">                <span class="keywordflow">foreach</span> my $msg (@$log_buffer) {</div>
<div class="line">                    $worker-&gt;worker_say( $msg );</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> scalar(@$workers_to_submit_by_analysis)</div>
<div class="line">                ? $workers_to_submit_by_analysis-&gt;[0][0]    # take the first analysis from the <span class="stringliteral">&quot;plan&quot;</span> <span class="keywordflow">if</span> the <span class="stringliteral">&quot;plan&quot;</span> was not empty</div>
<div class="line">                : pop @$log_buffer;                         # or <span class="keywordflow">return</span> the last line of the scheduling log</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>modules/Bio/EnsEMBL/Hive/<a class="el" href="_scheduler_8pm.html">Scheduler.pm</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespace_bio.html">Bio</a></li><li class="navelem"><a class="el" href="namespace_bio_1_1_ens_e_m_b_l.html">EnsEMBL</a></li><li class="navelem"><a class="el" href="namespace_bio_1_1_ens_e_m_b_l_1_1_hive.html">Hive</a></li><li class="navelem"><a class="el" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html">Scheduler</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
