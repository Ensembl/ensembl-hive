<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ensembl-hive: scripts/beekeeper.pl File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ensembl-hive
   &#160;<span id="projectnumber">2.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('beekeeper_8pl.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">beekeeper.pl File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a3ce8b237b3bdb2817dac6f769e5768c2"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> ()</td></tr>
<tr class="separator:a3ce8b237b3bdb2817dac6f769e5768c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad7de8680eb8b39e160cee04957ccd668"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="beekeeper_8pl.html#ad7de8680eb8b39e160cee04957ccd668">generate_worker_cmd</a> ()</td></tr>
<tr class="separator:ad7de8680eb8b39e160cee04957ccd668"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af314298b28a69538fb25aa7eb1327c98"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="beekeeper_8pl.html#af314298b28a69538fb25aa7eb1327c98">run_autonomously</a> ()</td></tr>
<tr class="separator:af314298b28a69538fb25aa7eb1327c98"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ad7de8680eb8b39e160cee04957ccd668"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public generate_worker_cmd </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-generate_worker_cmd" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-generate_worker_cmd-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-generate_worker_cmd-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-generate_worker_cmd-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#ad7de8680eb8b39e160cee04957ccd668">generate_worker_cmd</a> {</div>
<div class="line">    my ($self, $run_analysis, $run_job_id, $force) = @_;</div>
<div class="line"></div>
<div class="line">    my $worker_cmd = $ENV{<span class="stringliteral">&#39;EHIVE_ROOT_DIR&#39;</span>}.<span class="stringliteral">&#39;/scripts/runWorker.pl&#39;</span>;</div>
<div class="line"></div>
<div class="line">    unless(-x $worker_cmd) {</div>
<div class="line">        print(<span class="stringliteral">&quot;Can&#39;t run &#39;$worker_cmd&#39; script for some reason, please investigate.\n&quot;</span>);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $worker_option (<span class="stringliteral">&#39;url&#39;</span>, <span class="stringliteral">&#39;reg_conf&#39;</span>, <span class="stringliteral">&#39;reg_type&#39;</span>, <span class="stringliteral">&#39;reg_alias&#39;</span>, <span class="stringliteral">&#39;nosqlvc&#39;</span>, <span class="stringliteral">&#39;job_limit&#39;</span>, <span class="stringliteral">&#39;life_span&#39;</span>, <span class="stringliteral">&#39;retry_throwing_jobs&#39;</span>, <span class="stringliteral">&#39;can_respecialize&#39;</span>, <span class="stringliteral">&#39;hive_log_dir&#39;</span>, <span class="stringliteral">&#39;debug&#39;</span>) {</div>
<div class="line">        <span class="keywordflow">if</span>(defined(my $value = $self-&gt;{$worker_option})) {</div>
<div class="line">            $worker_cmd .= <span class="stringliteral">&quot; -${worker_option} $value&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        # special task:</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> ($run_job_id) {</div>
<div class="line">        $worker_cmd .= <span class="stringliteral">&quot; -job_id $run_job_id&quot;</span>;</div>
<div class="line">    } elsif ($run_analysis) {</div>
<div class="line">        $worker_cmd .= <span class="stringliteral">&quot; -logic_name &quot;</span>.$run_analysis-&gt;logic_name;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (defined($force)) {</div>
<div class="line">        $worker_cmd .= <span class="stringliteral">&quot; -force $force&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $worker_cmd;</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
<a class="anchor" id="a3ce8b237b3bdb2817dac6f769e5768c2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public main </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    $| = 1;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        # ok this is a hack, but I&#39;m going to pretend I&#39;ve got an object here</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        # by creating a hash ref and passing it around like an object</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        # this is to avoid using global variables in functions, and to consolidate</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        # the globals into a nice &#39;$self&#39; package</span></div>
<div class="line"><span class="preprocessor"></span>    my $self = {};</div>
<div class="line"></div>
<div class="line">    my $help                        = 0;</div>
<div class="line">    my $report_versions             = 0;</div>
<div class="line">    my $loopit                      = 0;</div>
<div class="line">    my $sync                        = 0;</div>
<div class="line">    my $local                       = 0;</div>
<div class="line">    my $show_failed_jobs            = 0;</div>
<div class="line">    my $default_meadow_type         = undef;</div>
<div class="line">    my $submit_workers_max          = undef;</div>
<div class="line">    my $total_running_workers_max   = undef;</div>
<div class="line">    my $submission_options          = undef;</div>
<div class="line">    my $run                         = 0;</div>
<div class="line">    my $max_loops                   = 0; # not running by <span class="keywordflow">default</span></div>
<div class="line">    my $run_job_id                  = undef;</div>
<div class="line">    my $force                       = undef;</div>
<div class="line">    my $keep_alive                  = 0; # ==1 means run even when there is nothing to <span class="keywordflow">do</span></div>
<div class="line">    my $check_for_dead              = 0;</div>
<div class="line">    my $all_dead                    = 0;</div>
<div class="line">    my $balance_semaphores          = 0;</div>
<div class="line">    my $job_id_for_output           = 0;</div>
<div class="line">    my $show_worker_stats           = 0;</div>
<div class="line">    my $kill_worker_id              = 0;</div>
<div class="line">    my $reset_job_id                = 0;</div>
<div class="line">    my $reset_all_jobs_for_analysis = 0;</div>
<div class="line">    my $reset_failed_jobs_for_analysis = 0;</div>
<div class="line"></div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;url&#39;</span>}                  = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;reg_conf&#39;</span>}             = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;reg_type&#39;</span>}             = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;reg_alias&#39;</span>}            = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;nosqlvc&#39;</span>}              = undef;</div>
<div class="line"></div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;sleep_minutes&#39;</span>}        = 1;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;retry_throwing_jobs&#39;</span>}  = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;can_respecialize&#39;</span>}     = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;hive_log_dir&#39;</span>}         = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;submit_stdout_file&#39;</span>}   = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;submit_stderr_file&#39;</span>}   = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;submit_log_dir&#39;</span>}       = undef;</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                    # connection parameters</div>
<div class="line">               <span class="stringliteral">&#39;url=s&#39;</span>              =&gt; \$self-&gt;{<span class="stringliteral">&#39;url&#39;</span>},</div>
<div class="line">               <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span> =&gt; \$self-&gt;{<span class="stringliteral">&#39;reg_conf&#39;</span>},</div>
<div class="line">               <span class="stringliteral">&#39;reg_type=s&#39;</span>         =&gt; \$self-&gt;{<span class="stringliteral">&#39;reg_type&#39;</span>},</div>
<div class="line">               <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>=&gt; \$self-&gt;{<span class="stringliteral">&#39;reg_alias&#39;</span>},</div>
<div class="line">               <span class="stringliteral">&#39;nosqlvc=i&#39;</span>          =&gt; \$self-&gt;{<span class="stringliteral">&#39;nosqlvc&#39;</span>},     # can<span class="stringliteral">&#39;t use the binary &quot;!&quot; as it is a propagated option</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    # loop control</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>run<span class="stringliteral">&#39;                =&gt; \$run,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>loop<span class="stringliteral">&#39;               =&gt; \$loopit,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>max_loops=i<span class="stringliteral">&#39;        =&gt; \$max_loops,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>keep_alive<span class="stringliteral">&#39;         =&gt; \$keep_alive,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>job_id|run_job_id=i<span class="stringliteral">&#39;=&gt; \$run_job_id,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>force=i<span class="stringliteral">&#39;            =&gt; \$force,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>sleep=f<span class="stringliteral">&#39;            =&gt; \$self-&gt;{&#39;</span>sleep_minutes<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    # meadow control</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>local!<span class="stringliteral">&#39;                         =&gt; \$local,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>meadow_type=s<span class="stringliteral">&#39;                  =&gt; \$default_meadow_type,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>total_running_workers_max=i<span class="stringliteral">&#39;    =&gt; \$total_running_workers_max,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>submit_workers_max=i<span class="stringliteral">&#39;           =&gt; \$submit_workers_max,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>submission_options=s<span class="stringliteral">&#39;           =&gt; \$submission_options,</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    # worker control</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>job_limit=i<span class="stringliteral">&#39;            =&gt; \$self-&gt;{&#39;</span>job_limit<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>life_span|lifespan=i<span class="stringliteral">&#39;   =&gt; \$self-&gt;{&#39;</span>life_span<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>logic_name=s<span class="stringliteral">&#39;           =&gt; \$self-&gt;{&#39;</span>logic_name<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>hive_log_dir|hive_output_dir=s<span class="stringliteral">&#39;      =&gt; \$self-&gt;{&#39;</span>hive_log_dir<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>retry_throwing_jobs=i<span class="stringliteral">&#39;  =&gt; \$self-&gt;{&#39;</span>retry_throwing_jobs<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>can_respecialize=i<span class="stringliteral">&#39;     =&gt; \$self-&gt;{&#39;</span>can_respecialize<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>debug=i<span class="stringliteral">&#39;                =&gt; \$self-&gt;{&#39;</span>debug<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>submit_stdout_file=s<span class="stringliteral">&#39;   =&gt; \$self-&gt;{&#39;</span>submit_stdout_file<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>submit_stderr_file=s<span class="stringliteral">&#39;   =&gt; \$self-&gt;{&#39;</span>submit_stderr_file<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>submit_log_dir=s<span class="stringliteral">&#39;       =&gt; \$self-&gt;{&#39;</span>submit_log_dir<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    # other commands/options</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>h|help!<span class="stringliteral">&#39;           =&gt; \$help,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>v|versions!<span class="stringliteral">&#39;       =&gt; \$report_versions,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>sync!<span class="stringliteral">&#39;             =&gt; \$sync,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>dead!<span class="stringliteral">&#39;             =&gt; \$check_for_dead,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>killworker=i<span class="stringliteral">&#39;      =&gt; \$kill_worker_id,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>alldead!<span class="stringliteral">&#39;          =&gt; \$all_dead,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>balance_semaphores<span class="stringliteral">&#39;=&gt; \$balance_semaphores,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>no_analysis_stats<span class="stringliteral">&#39; =&gt; \$self-&gt;{&#39;</span>no_analysis_stats<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>worker_stats<span class="stringliteral">&#39;      =&gt; \$show_worker_stats,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>failed_jobs<span class="stringliteral">&#39;       =&gt; \$show_failed_jobs,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>reset_job_id=i<span class="stringliteral">&#39;    =&gt; \$reset_job_id,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>reset_failed|reset_failed_jobs_for_analysis=s<span class="stringliteral">&#39; =&gt; \$reset_failed_jobs_for_analysis,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>reset_all|reset_all_jobs_for_analysis=s<span class="stringliteral">&#39; =&gt; \$reset_all_jobs_for_analysis,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>job_output=i<span class="stringliteral">&#39;      =&gt; \$job_id_for_output,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>monitor!<span class="stringliteral">&#39;          =&gt; \$self-&gt;{&#39;</span>monitor<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">    );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if ($help) { script_usage(0); }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($report_versions) {</span></div>
<div class="line"><span class="stringliteral">        report_versions();</span></div>
<div class="line"><span class="stringliteral">        exit(0);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $config = Bio::EnsEMBL::Hive::Utils::Config-&gt;new();      # will probably add a config_file option later</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($run or $run_job_id) {</span></div>
<div class="line"><span class="stringliteral">        $max_loops = 1;</span></div>
<div class="line"><span class="stringliteral">    } elsif ($loopit or $keep_alive) {</span></div>
<div class="line"><span class="stringliteral">        unless($max_loops) {</span></div>
<div class="line"><span class="stringliteral">            $max_loops = -1; # unlimited</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">        unless(defined($self-&gt;{&#39;</span>monitor<span class="stringliteral">&#39;})) {</span></div>
<div class="line"><span class="stringliteral">            $self-&gt;{&#39;</span>monitor<span class="stringliteral">&#39;} = 1;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($self-&gt;{&#39;</span>url<span class="stringliteral">&#39;} or $self-&gt;{&#39;</span>reg_alias<span class="stringliteral">&#39;}) {</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;{&#39;</span>dba<span class="stringliteral">&#39;} = Bio::EnsEMBL::Hive::DBSQL::DBAdaptor-&gt;new(</span></div>
<div class="line"><span class="stringliteral">            -url                            =&gt; $self-&gt;{&#39;</span>url<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">            -reg_conf                       =&gt; $self-&gt;{&#39;</span>reg_conf<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">            -reg_type                       =&gt; $self-&gt;{&#39;</span>reg_type<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">            -reg_alias                      =&gt; $self-&gt;{&#39;</span>reg_alias<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">            -no_sql_schema_version_check    =&gt; $self-&gt;{&#39;</span>nosqlvc<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral">    } else {</span></div>
<div class="line"><span class="stringliteral">        print &quot;\nERROR : Connection parameters (url or reg_conf+reg_alias) need to be specified\n\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        script_usage(1);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $self-&gt;{&#39;</span>safe_url<span class="stringliteral">&#39;} = $self-&gt;{&#39;</span>dba<span class="stringliteral">&#39;}-&gt;dbc-&gt;url(&#39;</span>WORKER_PASSWORD<span class="stringliteral">&#39;);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $queen = $self-&gt;{&#39;</span>dba<span class="stringliteral">&#39;}-&gt;get_Queen;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $pipeline_name = $self-&gt;{&#39;</span>dba<span class="stringliteral">&#39;}-&gt;get_MetaAdaptor-&gt;fetch_value_by_key( &#39;</span>hive_pipeline_name<span class="stringliteral">&#39; );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($pipeline_name) {</span></div>
<div class="line"><span class="stringliteral">        warn &quot;Pipeline name: $pipeline_name\n&quot;;</span></div>
<div class="line"><span class="stringliteral">    } else {</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;+---------------------------------------------------------------------+\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;!                                                                     !\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;!                  WARNING:                                           !\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;!                                                                     !\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;! At the moment your pipeline doesn&#39;</span>t have <span class="stringliteral">&#39;pipeline_name&#39;</span> defined.   !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>! This may seriously impair your beekeeping experience unless you are !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>! the only farm user. The name should be set in your PipeConfig file, !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>! or <span class="keywordflow">if</span> you are running an old pipeline you can just set it by hand   !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>! in the <span class="stringliteral">&#39;meta&#39;</span> table.                                                !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>!                                                                     !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>+---------------------------------------------------------------------+\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($run_job_id) {</span></div>
<div class="line"><span class="stringliteral">        $submit_workers_max = 1;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $default_meadow_type = &#39;LOCAL&#39; if($local);</span></div>
<div class="line"><span class="stringliteral">    my $valley = Bio::EnsEMBL::Hive::Valley-&gt;new( $config, $default_meadow_type, $pipeline_name );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my ($beekeeper_meadow_type, $beekeeper_meadow_name) = $valley-&gt;whereami();</span></div>
<div class="line"><span class="stringliteral">    unless($beekeeper_meadow_type eq &#39;LOCAL&#39;) {</span></div>
<div class="line"><span class="stringliteral">        die &quot;</span>beekeeper.pl detected it has been itself submitted to <span class="stringliteral">&#39;$beekeeper_meadow_type/$beekeeper_meadow_name&#39;</span>, but <span class="keyword">this</span> mode of operation is not supported.\n<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">           .&quot;</span>Please just run beekeeper.pl on a farm head node, preferably from under a <span class="stringliteral">&#39;screen&#39;</span> session.\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $valley-&gt;config_set(&#39;SubmitWorkersMax&#39;, $submit_workers_max) if(defined $submit_workers_max);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $default_meadow = $valley-&gt;get_default_meadow();</span></div>
<div class="line"><span class="stringliteral">    warn &quot;</span>Default meadow: <span class="stringliteral">&quot;.$default_meadow-&gt;signature.&quot;</span>\n\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $default_meadow-&gt;config_set(&#39;TotalRunningWorkersMax&#39;, $total_running_workers_max) if(defined $total_running_workers_max);</span></div>
<div class="line"><span class="stringliteral">    $default_meadow-&gt;config_set(&#39;SubmissionOptions&#39;, $submission_options) if(defined $submission_options);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($reset_job_id) { $queen-&gt;reset_job_by_dbID_and_sync($reset_job_id); }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($job_id_for_output) {</span></div>
<div class="line"><span class="stringliteral">        printf(&quot;</span>===== job output\n<span class="stringliteral">&quot;);</span></div>
<div class="line"><span class="stringliteral">        my $job = $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisJobAdaptor-&gt;fetch_by_dbID($job_id_for_output);</span></div>
<div class="line"><span class="stringliteral">        $job-&gt;print_job();</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if(my $reset_logic_name = $reset_all_jobs_for_analysis || $reset_failed_jobs_for_analysis) {</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my $reset_analysis = $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisAdaptor-&gt;fetch_by_logic_name($reset_logic_name)</span></div>
<div class="line"><span class="stringliteral">              || die( &quot;</span>Cannot AnalysisAdaptor-&gt;fetch_by_logic_name($reset_logic_name)<span class="stringliteral">&quot;); </span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisJobAdaptor-&gt;reset_jobs_for_analysis_id($reset_analysis-&gt;dbID, $reset_all_jobs_for_analysis); </span></div>
<div class="line"><span class="stringliteral">        $self-&gt;{&#39;dba&#39;}-&gt;get_Queen-&gt;synchronize_AnalysisStats($reset_analysis-&gt;stats);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if ($kill_worker_id) {</span></div>
<div class="line"><span class="stringliteral">        my $kill_worker = $queen-&gt;fetch_by_dbID($kill_worker_id);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        unless( $kill_worker-&gt;cause_of_death() ) {</span></div>
<div class="line"><span class="stringliteral">            if( my $meadow = $valley-&gt;find_available_meadow_responsible_for_worker( $kill_worker ) ) {</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                if( $meadow-&gt;check_worker_is_alive_and_mine ) {</span></div>
<div class="line"><span class="stringliteral">                    printf(&quot;</span>Killing worker: %10d %35s %15s  %20s(%d) : <span class="stringliteral">&quot;, </span></div>
<div class="line"><span class="stringliteral">                            $kill_worker-&gt;dbID, $kill_worker-&gt;host, $kill_worker-&gt;process_id, </span></div>
<div class="line"><span class="stringliteral">                            $kill_worker-&gt;analysis-&gt;logic_name, $kill_worker-&gt;analysis_id);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    $meadow-&gt;kill_worker($kill_worker);</span></div>
<div class="line"><span class="stringliteral">                    $kill_worker-&gt;cause_of_death(&#39;KILLED_BY_USER&#39;);</span></div>
<div class="line"><span class="stringliteral">                    $queen-&gt;register_worker_death($kill_worker);</span></div>
<div class="line"><span class="stringliteral">                         # what about clean-up? Should we do it here or not?</span></div>
<div class="line"><span class="stringliteral">                } else {</span></div>
<div class="line"><span class="stringliteral">                    die &quot;</span>According to the Meadow, the Worker (dbID=$kill_worker_id) is not running, so cannot kill<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">                }</span></div>
<div class="line"><span class="stringliteral">            } else {</span></div>
<div class="line"><span class="stringliteral">                die &quot;</span>Cannot access the Meadow responsible for the Worker (dbID=$kill_worker_id), so cannot kill<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">        } else {</span></div>
<div class="line"><span class="stringliteral">            die &quot;</span>According to the Queen, the Worker (dbID=$kill_worker_id) is not running, so cannot kill<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $analysis = $run_job_id</span></div>
<div class="line"><span class="stringliteral">        ? $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisAdaptor-&gt;fetch_by_dbID( $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisJobAdaptor-&gt;fetch_by_dbID( $run_job_id )-&gt;analysis_id )</span></div>
<div class="line"><span class="stringliteral">        : $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisAdaptor-&gt;fetch_by_logic_name($self-&gt;{&#39;logic_name&#39;});</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($all_dead)           { $queen-&gt;register_all_workers_dead(); }</span></div>
<div class="line"><span class="stringliteral">    if($check_for_dead)     { $queen-&gt;check_for_dead_workers($valley, 1); }</span></div>
<div class="line"><span class="stringliteral">    if($balance_semaphores) { $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisJobAdaptor-&gt;balance_semaphores( $analysis &amp;&amp; $analysis-&gt;dbID ); }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if ($max_loops) { # positive $max_loop means limited, negative means unlimited</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        run_autonomously($self, $max_loops, $keep_alive, $queen, $valley, $analysis, $run_job_id, $force);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    } else {</span></div>
<div class="line"><span class="stringliteral">            # the output of several methods will look differently depending on $analysis being [un]defined</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        if($sync) {</span></div>
<div class="line"><span class="stringliteral">            $queen-&gt;synchronize_hive($analysis);</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">        $queen-&gt;print_analysis_status($analysis) unless($self-&gt;{&#39;no_analysis_stats&#39;});</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        if($show_worker_stats) {</span></div>
<div class="line"><span class="stringliteral">            print &quot;</span>\n===== List of live Workers according to the Queen: ======\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">            foreach my $worker (@{ $queen-&gt;fetch_overdue_workers(0) }) {</span></div>
<div class="line"><span class="stringliteral">                print $worker-&gt;toString().&quot;</span>\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">        $queen-&gt;print_running_worker_counts;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        Bio::EnsEMBL::Hive::Scheduler::schedule_workers_resync_if_necessary($queen, $valley, $analysis);   # show what would be submitted, but do not actually submit</span></div>
<div class="line"><span class="stringliteral">        $queen-&gt;get_remaining_jobs_show_hive_progress();</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        if($show_failed_jobs) {</span></div>
<div class="line"><span class="stringliteral">            print(&quot;</span>===== failed jobs\n<span class="stringliteral">&quot;);</span></div>
<div class="line"><span class="stringliteral">            my $failed_job_list = $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisJobAdaptor-&gt;fetch_all_by_analysis_id_status($analysis &amp;&amp; $analysis-&gt;dbID, &#39;FAILED&#39;);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            foreach my $job (@{$failed_job_list}) {</span></div>
<div class="line"><span class="stringliteral">                $job-&gt;print_job();</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if ($self-&gt;{&#39;monitor&#39;}) {</span></div>
<div class="line"><span class="stringliteral">        $queen-&gt;monitor();</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    exit(0);</span></div>
<div class="line"><span class="stringliteral">}</span></div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my ($reg_conf, $reg_type, $reg_alias, $url, $sqlcmd, $extra, $to_params, $verbose, $help, $report_versions);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf=s&#39;</span>        =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>        =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias=s&#39;</span>       =&gt; \$reg_alias,</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>             =&gt; \$url,</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;sqlcmd=s&#39;</span>          =&gt; \$sqlcmd,</div>
<div class="line">            <span class="stringliteral">&#39;extra=s&#39;</span>           =&gt; \$extra,</div>
<div class="line">            <span class="stringliteral">&#39;to_params!&#39;</span>        =&gt; \$to_params,</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;verbose!&#39;</span>          =&gt; \$verbose,</div>
<div class="line">            <span class="stringliteral">&#39;help!&#39;</span>             =&gt; \$help,</div>
<div class="line">            <span class="stringliteral">&#39;v|versions!&#39;</span>       =&gt; \$report_versions,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my $dbc_hash;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($help) {</div>
<div class="line"></div>
<div class="line">        script_usage(0);</div>
<div class="line"></div>
<div class="line">    } elsif($report_versions) {</div>
<div class="line"></div>
<div class="line">        report_versions();</div>
<div class="line">        exit(0);</div>
<div class="line"></div>
<div class="line">    } elsif($reg_alias) {</div>
<div class="line">        script_usage(1) if $url;</div>
<div class="line"></div>
<div class="line">        require Bio::EnsEMBL::Registry;</div>
<div class="line">        Bio::EnsEMBL::Registry-&gt;load_all($reg_conf);</div>
<div class="line"></div>
<div class="line">        my $species = Bio::EnsEMBL::Registry-&gt;get_alias($reg_alias)</div>
<div class="line">            || die &quot;Could not solve the alias &#39;$reg_alias&#39;&quot;.($reg_conf ? &quot; via the registry file &#39;$reg_conf&#39;&quot; : &quot;&quot;);</div>
<div class="line"></div>
<div class="line">        my $dba;</div>
<div class="line">        if ($reg_type) {</div>
<div class="line">            $dba = Bio::EnsEMBL::Registry-&gt;get_DBAdaptor($species, $reg_type)</div>
<div class="line">                || die <span class="stringliteral">&quot;Could not find any database for &#39;$species&#39; (alias: &#39;$reg_alias&#39;) with the type &#39;$reg_type&#39;&quot;</span>.($reg_conf ? <span class="stringliteral">&quot; via the registry file &#39;$reg_conf&#39;&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"></div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">            my $dbas = Bio::EnsEMBL::Registry-&gt;get_all_DBAdaptors(-species =&gt; $species);</div>
<div class="line">            <span class="keywordflow">if</span> (scalar(@$dbas) == 0) {</div>
<div class="line"><span class="preprocessor">                # I think this case cannot happen: if there are no databases, the alias does not exist and get_alias() should have failed</span></div>
<div class="line"><span class="preprocessor"></span>                die <span class="stringliteral">&quot;Could not find any database for &#39;$species&#39; (alias: &#39;$reg_alias&#39;)&quot;</span>.($reg_conf ? <span class="stringliteral">&quot; via the registry file &#39;$reg_conf&#39;&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"></div>
<div class="line">            } elsif (scalar(@$dbas) &gt;= 2) {</div>
<div class="line">                die <span class="stringliteral">&quot;There are several databases for &#39;$species&#39; (alias: &#39;$reg_alias&#39;). Please set -reg_type to one of: &quot;</span>.join(<span class="stringliteral">&quot;, &quot;</span>, map {$_-&gt;group} @$dbas);</div>
<div class="line">            };</div>
<div class="line">            $dba = $dbas-&gt;[0];</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        my $dbc = $dba-&gt;dbc();</div>
<div class="line"></div>
<div class="line">        $dbc_hash = {</div>
<div class="line">            <span class="stringliteral">&#39;driver&#39;</span>    =&gt; $dbc-&gt;driver,</div>
<div class="line">            <span class="stringliteral">&#39;host&#39;</span>      =&gt; $dbc-&gt;host,</div>
<div class="line">            <span class="stringliteral">&#39;port&#39;</span>      =&gt; $dbc-&gt;port,</div>
<div class="line">            <span class="stringliteral">&#39;user&#39;</span>      =&gt; $dbc-&gt;username,</div>
<div class="line">            <span class="stringliteral">&#39;pass&#39;</span>      =&gt; $dbc-&gt;password,</div>
<div class="line">            <span class="stringliteral">&#39;dbname&#39;</span>    =&gt; $dbc-&gt;dbname,</div>
<div class="line">        };</div>
<div class="line">    } elsif($url) {</div>
<div class="line">        $dbc_hash = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_utils_1_1_u_r_l.html#ac80cc911eba215fb0ed17104861fe5f7">Bio::EnsEMBL::Hive::Utils::URL::parse</a>( $url )</div>
<div class="line">            || die <span class="stringliteral">&quot;Could not parse URL &#39;$url&#39;&quot;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $cmd = <a class="code" href="db__cmd_8pl.html#aa9d6dbdd85d225abef029815f3ca0336">dbc_hash_to_cmd</a>( $dbc_hash, $sqlcmd, $extra, $to_params );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($to_params) {</div>
<div class="line">        print <span class="stringliteral">&quot;$cmd\n&quot;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;\nRunning command:\t$cmd\n\n&quot;</span> <span class="keywordflow">if</span>($verbose);</div>
<div class="line"></div>
<div class="line">        exec($cmd);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line"></div>
<div class="line">    my ($url, $reg_conf, $reg_type, $reg_alias, $nosqlvc, $help, $verbose, $mode, $start_date, $end_date, $output, $top, $default_memory, $default_cores);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>                      =&gt; \$url,</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span>         =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>                 =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>        =&gt; \$reg_alias,</div>
<div class="line">            <span class="stringliteral">&#39;nosqlvc=i&#39;</span>                  =&gt; \$nosqlvc,      # <span class="keyword">using</span> <span class="stringliteral">&quot;=i&quot;</span> instead of <span class="stringliteral">&quot;!&quot;</span> <span class="keywordflow">for</span> consistency with scripts where it is a propagated option</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;verbose!&#39;</span>                   =&gt; \$verbose,</div>
<div class="line">            <span class="stringliteral">&#39;h|help&#39;</span>                     =&gt; \$help,</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;start_date=s&#39;</span>               =&gt; \$start_date,</div>
<div class="line">            <span class="stringliteral">&#39;end_date=s&#39;</span>                 =&gt; \$end_date,</div>
<div class="line">            <span class="stringliteral">&#39;mode=s&#39;</span>                     =&gt; \$mode,</div>
<div class="line">            <span class="stringliteral">&#39;top=f&#39;</span>                      =&gt; \$top,</div>
<div class="line">            <span class="stringliteral">&#39;mem=i&#39;</span>                      =&gt; \$default_memory,</div>
<div class="line">            <span class="stringliteral">&#39;n_core=i&#39;</span>                   =&gt; \$default_cores,</div>
<div class="line">            <span class="stringliteral">&#39;output=s&#39;</span>                   =&gt; \$output,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($help) { script_usage(0); }</div>
<div class="line"></div>
<div class="line">    my $hive_dba;</div>
<div class="line">    <span class="keywordflow">if</span>($url or $reg_alias) {</div>
<div class="line">        $hive_dba = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">                -url                            =&gt; $url,</div>
<div class="line">                -reg_conf                       =&gt; $reg_conf,</div>
<div class="line">                -reg_type                       =&gt; $reg_type,</div>
<div class="line">                -reg_alias                      =&gt; $reg_alias,</div>
<div class="line">                -no_sql_schema_version_check    =&gt; $nosqlvc,</div>
<div class="line">        );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;\nERROR: Connection parameters (url or reg_conf+reg_alias) need to be specified\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Check whether $mode is valid</span></div>
<div class="line"><span class="preprocessor"></span>    my %allowed_modes = (</div>
<div class="line">        workers =&gt; <span class="stringliteral">&#39;Number of workers&#39;</span>,</div>
<div class="line">        memory =&gt; <span class="stringliteral">&#39;Memory asked (Gb)&#39;</span>,</div>
<div class="line">        cores =&gt; <span class="stringliteral">&#39;Number of CPU cores&#39;</span>,</div>
<div class="line">        unused_memory =&gt; <span class="stringliteral">&#39;Unused memory (Gb)&#39;</span>,</div>
<div class="line">        unused_cores =&gt; <span class="stringliteral">&#39;Number of unused CPU cores&#39;</span>,</div>
<div class="line">        pending_workers =&gt; <span class="stringliteral">&#39;Number of pending workers&#39;</span>,</div>
<div class="line">    );</div>
<div class="line">    <span class="keywordflow">if</span> ($mode) {</div>
<div class="line">        die <span class="stringliteral">&quot;Unknown mode &#39;$mode&#39;. Allowed modes are: &quot;</span>.join(<span class="stringliteral">&quot;, &quot;</span>, keys %allowed_modes) unless exists $allowed_modes{$mode};</div>
<div class="line">        $default_memory = 100 unless $default_memory;</div>
<div class="line">        $default_cores = 1 unless $default_cores;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        $mode = <span class="stringliteral">&#39;workers&#39;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Palette generated with R: c(brewer.pal(9, &quot;Set1&quot;), brewer.pal(12, &quot;Set3&quot;)). #FFFFB3 is removed because it is too close to white</span></div>
<div class="line"><span class="preprocessor"></span>    my @palette = qw(#E41A1C #377EB8 #4DAF4A #984EA3 #FF7F00 #FFFF33 #A65628 #F781BF #999999     #8DD3C7 #BEBADA #FB8072 #80B1D3 #FDB462 #B3DE69 #FCCDE5 #D9D9D9 #BC80BD #CCEBC5 #FFED6F    #2F4F4F);</div>
<div class="line"></div>
<div class="line">    my %terminal_mapping = (</div>
<div class="line">        <span class="stringliteral">&#39;emf&#39;</span> =&gt; <span class="stringliteral">&#39;emf&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;png&#39;</span> =&gt; <span class="stringliteral">&#39;png&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;svg&#39;</span> =&gt; <span class="stringliteral">&#39;svg&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;jpg&#39;</span> =&gt; <span class="stringliteral">&#39;jpeg&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;gif&#39;</span> =&gt; <span class="stringliteral">&#39;gif&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;ps&#39;</span>  =&gt; <span class="stringliteral">&#39;postscript eps enhanced color&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;pdf&#39;</span> =&gt; <span class="stringliteral">&#39;pdf color enhanced&#39;</span>,</div>
<div class="line">    );</div>
<div class="line">    my $gnuplot_terminal = undef;</div>
<div class="line">    <span class="keywordflow">if</span> ($output and $output =~ /\.(\w+)$/) {</div>
<div class="line">        $gnuplot_terminal = $1;</div>
<div class="line">        die <span class="stringliteral">&quot;The format &#39;$gnuplot_terminal&#39; is not currently supported.&quot;</span> <span class="keywordflow">if</span> not exists $terminal_mapping{$gnuplot_terminal};</div>
<div class="line">        require Chart::Gnuplot;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    my $dbh = $hive_dba-&gt;dbc-&gt;db_handle();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Get the memory usage from each resource_class</span></div>
<div class="line"><span class="preprocessor"></span>    my %mem_resources = ();</div>
<div class="line">    my %cpu_resources = ();</div>
<div class="line">    {</div>
<div class="line">        my $sql_resource_descriptions = <span class="stringliteral">&#39;SELECT resource_class_id, meadow_type, submission_cmd_args FROM resource_description&#39;</span>;</div>
<div class="line">        <span class="keywordflow">foreach</span> my $db_entry (@{$dbh-&gt;selectall_arrayref($sql_resource_descriptions)}) {</div>
<div class="line">            my ($resource_class_id, $meadow_type, $submission_cmd_args) = @$db_entry;</div>
<div class="line">            <span class="keywordflow">if</span> ($meadow_type eq <span class="stringliteral">&#39;LSF&#39;</span>) {</div>
<div class="line">                $mem_resources{$resource_class_id} = $1 <span class="keywordflow">if</span> $submission_cmd_args =~ m/mem=(\d+)/;</div>
<div class="line">                $cpu_resources{$resource_class_id} = $1 <span class="keywordflow">if</span> $submission_cmd_args =~ m/-n\s*(\d+)/;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    warn <span class="stringliteral">&quot;mem_resources: &quot;</span>, Dumper \%mem_resources <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    warn <span class="stringliteral">&quot;cpu_resources: &quot;</span>, Dumper \%cpu_resources <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Get the memory used by each worker</span></div>
<div class="line"><span class="preprocessor"></span>    my %used_res = ();</div>
<div class="line">    <span class="keywordflow">if</span> (($mode eq <span class="stringliteral">&#39;unused_memory&#39;</span>) or ($mode eq <span class="stringliteral">&#39;unused_cores&#39;</span>)) {</div>
<div class="line">        my $sql_used_res = <span class="stringliteral">&#39;SELECT meadow_name, process_id, mem_megs, cpu_sec/lifespan_sec FROM lsf_report&#39;</span>;</div>
<div class="line">        <span class="keywordflow">foreach</span> my $db_entry (@{$dbh-&gt;selectall_arrayref($sql_used_res)}) {</div>
<div class="line">            my ($meadow_name, $process_id, $mem_megs, $cpu_usage) = @$db_entry;</div>
<div class="line">            $used_res{$meadow_name.<span class="stringliteral">&quot;_____&quot;</span>.$process_id} = [$mem_megs, $cpu_usage];</div>
<div class="line">        }</div>
<div class="line">        warn scalar(keys %used_res), <span class="stringliteral">&quot; process info loaded from lsf_report\n&quot;</span> <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Get the info about the analysis</span></div>
<div class="line"><span class="preprocessor"></span>    my %default_resource_class = ();</div>
<div class="line">    my %analysis_name = ();</div>
<div class="line">    {</div>
<div class="line">        my $sql_analysis_info = <span class="stringliteral">&#39;SELECT analysis_id, logic_name, resource_class_id FROM analysis_base&#39;</span>;</div>
<div class="line">        <span class="keywordflow">foreach</span> my $db_entry (@{$dbh-&gt;selectall_arrayref($sql_analysis_info)}) {</div>
<div class="line">            my ($analysis_id, $logic_name, $resource_class_id) = @$db_entry;</div>
<div class="line">            $analysis_name{$analysis_id} = $logic_name;</div>
<div class="line">            $default_resource_class{$analysis_id} = $resource_class_id;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    warn <span class="stringliteral">&quot;default_resource_class: &quot;</span>, Dumper \%default_resource_class <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    warn <span class="stringliteral">&quot;analysis_name: &quot;</span>, Dumper \%analysis_name <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    warn scalar(keys %analysis_name), <span class="stringliteral">&quot; analysis\n&quot;</span> <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Get the events from the database</span></div>
<div class="line"><span class="preprocessor"></span>    my %events = ();</div>
<div class="line">    <span class="keywordflow">if</span> ($mode ne <span class="stringliteral">&#39;pending_workers&#39;</span>) {</div>
<div class="line">        my @tmp_dates = @{$dbh-&gt;selectall_arrayref(<span class="stringliteral">&#39;SELECT DATE_FORMAT(born, &quot;%Y-%m-%dT%T&quot;), DATE_FORMAT(died, &quot;%Y-%m-%dT%T&quot;), analysis_id, meadow_name, process_id, resource_class_id FROM worker WHERE analysis_id IS NOT NULL&#39;</span>)};</div>
<div class="line">        warn scalar(@tmp_dates), <span class="stringliteral">&quot; events\n&quot;</span> <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">foreach</span> my $db_entry (@tmp_dates) {</div>
<div class="line">            my ($birth_date, $death_date, $analysis_id, $meadow_name, $process_id, $resource_class_id) = @$db_entry;</div>
<div class="line">            $resource_class_id = $default_resource_class{$analysis_id} unless $resource_class_id;</div>
<div class="line">            my $offset = 0;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> ($mode eq <span class="stringliteral">&#39;workers&#39;</span>) {</div>
<div class="line">                $offset = 1;</div>
<div class="line">            } elsif ($mode eq <span class="stringliteral">&#39;memory&#39;</span>) {</div>
<div class="line">                $offset = ($mem_resources{$resource_class_id} || $default_memory) / 1024.;</div>
<div class="line">            } elsif ($mode eq <span class="stringliteral">&#39;cores&#39;</span>) {</div>
<div class="line">                $offset = ($cpu_resources{$resource_class_id} || $default_cores);</div>
<div class="line">            } elsif ($mode eq <span class="stringliteral">&#39;unused_memory&#39;</span>) {</div>
<div class="line">                my $process_signature = $meadow_name.<span class="stringliteral">&quot;_____&quot;</span>.$process_id;</div>
<div class="line">                <span class="keywordflow">if</span> (exists $used_res{$process_signature}) {</div>
<div class="line">                    $offset = (($mem_resources{$resource_class_id} || $default_memory) - $used_res{$process_signature}-&gt;[0]) / 1024.;</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                my $process_signature = $meadow_name.<span class="stringliteral">&quot;_____&quot;</span>.$process_id;</div>
<div class="line">                <span class="keywordflow">if</span> (exists $used_res{$process_signature}) {</div>
<div class="line">                    $offset = ($cpu_resources{$resource_class_id} || $default_cores) - $used_res{$process_signature}-&gt;[1];</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            $events{$birth_date}{$analysis_id} += $offset <span class="keywordflow">if</span> $offset &gt; 0;</div>
<div class="line">            $events{$death_date}{$analysis_id} -= $offset <span class="keywordflow">if</span> ($offset &gt; 0) and $death_date;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        my @tmp_dates = @{$dbh-&gt;selectall_arrayref(<span class="stringliteral">&#39;SELECT DATE_FORMAT(DATE_SUB(born, INTERVAL pending_sec SECOND), &quot;%Y-%m-%dT%T&quot;), DATE_FORMAT(born, &quot;%Y-%m-%dT%T&quot;), analysis_id FROM worker JOIN lsf_report USING (meadow_name, process_id) WHERE analysis_id IS NOT NULL AND meadow_type = &quot;LSF&quot; AND pending_sec &gt; 0&#39;</span>)};</div>
<div class="line">        warn scalar(@tmp_dates), <span class="stringliteral">&quot; events\n&quot;</span> <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">foreach</span> my $db_entry (@tmp_dates) {</div>
<div class="line">            my ($start_pending, $start_running, $analysis_id) = @$db_entry;</div>
<div class="line">            $events{$start_pending}{$analysis_id} += 1;</div>
<div class="line">            $events{$start_running}{$analysis_id} -= 1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    my @event_dates = sort {$a cmp $b} (keys %events);</div>
<div class="line">    warn scalar(@event_dates), <span class="stringliteral">&quot; dates\n&quot;</span> <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">    my $max_workers = 0;</div>
<div class="line">    my @data_timings = ();</div>
<div class="line">    my %tot_analysis = ();</div>
<div class="line"></div>
<div class="line">    my $num_curr_workers = 0;</div>
<div class="line">    my %hash_curr_workers = (map {$_ =&gt; 0 } (keys %analysis_name));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $event_date (@event_dates) {</div>
<div class="line"></div>
<div class="line">        last <span class="keywordflow">if</span> $end_date and ($event_date gt $end_date);</div>
<div class="line"></div>
<div class="line">        my $topup_hash = $events{$event_date};</div>
<div class="line">        <span class="keywordflow">foreach</span> my $analysis_id (keys %$topup_hash) {</div>
<div class="line">            $hash_curr_workers{$analysis_id} += $topup_hash-&gt;{$analysis_id};</div>
<div class="line">            $num_curr_workers += $topup_hash-&gt;{$analysis_id};</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        # Due to rounding errors, the sums may be slightly different</span></div>
<div class="line"><span class="preprocessor"></span>        die sum(values %hash_curr_workers).<span class="stringliteral">&quot;!=$num_curr_workers&quot;</span> <span class="keywordflow">if</span> abs(sum(values %hash_curr_workers) - $num_curr_workers) &gt; 0.05;</div>
<div class="line"></div>
<div class="line">        next <span class="keywordflow">if</span> $start_date and ($event_date lt $start_date);</div>
<div class="line"></div>
<div class="line">        my %hash_interval = %hash_curr_workers;</div>
<div class="line"><span class="preprocessor">        #FIXME It should be normalised by the length of the time interval</span></div>
<div class="line"><span class="preprocessor"></span>        map {$tot_analysis{$_} += $hash_interval{$_}} keys %hash_interval;</div>
<div class="line"></div>
<div class="line">        $max_workers = $num_curr_workers <span class="keywordflow">if</span> ($num_curr_workers &gt; $max_workers);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        # We need to repeat the previous value to have an histogram shape</span></div>
<div class="line"><span class="preprocessor"></span>        push @data_timings, [$event_date, $data_timings[-1]-&gt;[1]] <span class="keywordflow">if</span> @data_timings;</div>
<div class="line">        push @data_timings, [$event_date, \%hash_interval];</div>
<div class="line">    }</div>
<div class="line">    warn $max_workers <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    warn Dumper \%tot_analysis <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">    my $total_total = sum(values %tot_analysis);</div>
<div class="line"></div>
<div class="line">    my @sorted_analysis_ids = sort {($tot_analysis{$b} &lt;=&gt; $tot_analysis{$a}) || (lc $analysis_name{$a} cmp lc $analysis_name{$b})} (grep {$tot_analysis{$_}} keys %tot_analysis);</div>
<div class="line">    warn Dumper \@sorted_analysis_ids <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    warn Dumper([map {$analysis_name{$_}} @sorted_analysis_ids]) <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (not $gnuplot_terminal) {</div>
<div class="line">        print join(<span class="stringliteral">&quot;\t&quot;</span>, <span class="stringliteral">&#39;date&#39;</span>, <span class="stringliteral">&quot;OVERALL_$mode&quot;</span>, map {$analysis_name{$_}} @sorted_analysis_ids), <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        print join(<span class="stringliteral">&quot;\t&quot;</span>, <span class="stringliteral">&#39;total&#39;</span>, $total_total, map {$tot_analysis{$_}} @sorted_analysis_ids), <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        print join(<span class="stringliteral">&quot;\t&quot;</span>, <span class="stringliteral">&#39;proportion&#39;</span>, <span class="stringliteral">&#39;NA&#39;</span>, map {$tot_analysis{$_}/$total_total} @sorted_analysis_ids), <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        my $s = 0;</div>
<div class="line">        print join(<span class="stringliteral">&quot;\t&quot;</span>, <span class="stringliteral">&#39;cum_proportion&#39;</span>, <span class="stringliteral">&#39;NA&#39;</span>, map {$s+=$tot_analysis{$_}/$total_total} @sorted_analysis_ids), <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">foreach</span> my $row (@data_timings) {</div>
<div class="line">            print join(<span class="stringliteral">&quot;\t&quot;</span>, $row-&gt;[0], sum(values %{$row-&gt;[1]}), map {$row-&gt;[1]-&gt;{$_}} @sorted_analysis_ids).<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Get the number of analysis we want to display</span></div>
<div class="line"><span class="preprocessor"></span>    my $n_relevant_analysis = scalar(@sorted_analysis_ids);</div>
<div class="line">    <span class="keywordflow">if</span> ($top and ($top &gt; 0)) {</div>
<div class="line">        <span class="keywordflow">if</span> ($top &lt; 1) {</div>
<div class="line">            my $s = 0;</div>
<div class="line">            $n_relevant_analysis = 0;</div>
<div class="line">            map {my $pre_s = $s; $s += $tot_analysis{$_}/$total_total; $pre_s &lt; $top &amp;&amp; $n_relevant_analysis++} @sorted_analysis_ids;</div>
<div class="line">        } elsif ($top &lt; scalar(@sorted_analysis_ids)) {</div>
<div class="line">            $n_relevant_analysis = $top;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    # cap based on the length of the palette</span></div>
<div class="line"><span class="preprocessor"></span>    my $need_other_analysis = $n_relevant_analysis &lt; scalar(@sorted_analysis_ids) ? 1 : 0;</div>
<div class="line">    <span class="keywordflow">if</span> (($n_relevant_analysis+$need_other_analysis) &gt; scalar(@palette)) {</div>
<div class="line">        $n_relevant_analysis = scalar(@palette) - 1;</div>
<div class="line">        $need_other_analysis = 1;</div>
<div class="line">    }</div>
<div class="line">    $top = $n_relevant_analysis unless $top;</div>
<div class="line">    warn <span class="stringliteral">&quot;$n_relevant_analysis relevant analysis\n&quot;</span> <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">    my @xdata = map {$_-&gt;[0]} @data_timings;</div>
<div class="line"></div>
<div class="line">    my @datasets = ();</div>
<div class="line"></div>
<div class="line">    my $pseudo_zero_value = -$max_workers / 50;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # The background plot: the sum of all the analysis</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> ($need_other_analysis) {</div>
<div class="line">        my @ydata = ();</div>
<div class="line">        <span class="keywordflow">foreach</span> my $row (@data_timings) {</div>
<div class="line">            push @ydata, sum(map {$row-&gt;[1]-&gt;{$_}} @sorted_analysis_ids ) || $pseudo_zero_value;</div>
<div class="line"><span class="preprocessor">            # Due to rounding errors, values are not always decreased to 0</span></div>
<div class="line"><span class="preprocessor"></span>            $ydata[-1] = $pseudo_zero_value <span class="keywordflow">if</span> $ydata[-1] &lt; 0.05;</div>
<div class="line">        }</div>
<div class="line">        push @datasets, Chart::Gnuplot::DataSet-&gt;new(</div>
<div class="line">            xdata =&gt; \@xdata,</div>
<div class="line">            ydata =&gt; \@ydata,</div>
<div class="line">            timefmt =&gt; <span class="stringliteral">&#39;%Y-%m-%dT%H:%M:%S&#39;</span>,</div>
<div class="line">            title =&gt; <span class="stringliteral">&#39;OTHER&#39;</span>,</div>
<div class="line">            style =&gt; <span class="stringliteral">&#39;filledcurves x1&#39;</span>,</div>
<div class="line">            linewidth =&gt; <span class="charliteral">&#39;0&#39;</span>,</div>
<div class="line">            color =&gt; $palette[$n_relevant_analysis],</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Each analysis is plotted as the sum of itself and the top ones</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $i (reverse 1..$n_relevant_analysis) {</div>
<div class="line">        my @ydata;</div>
<div class="line">        <span class="keywordflow">foreach</span> my $row (@data_timings) {</div>
<div class="line">            push @ydata, sum(map {$row-&gt;[1]-&gt;{$_} || 0} @sorted_analysis_ids[0..($i-1)] ) || $pseudo_zero_value;</div>
<div class="line"><span class="preprocessor">            # Due to rounding errors, values are not always decreased to 0</span></div>
<div class="line"><span class="preprocessor"></span>            $ydata[-1] = $pseudo_zero_value <span class="keywordflow">if</span> $ydata[-1] &lt; 0.05;</div>
<div class="line">        }</div>
<div class="line">        my $dataset = Chart::Gnuplot::DataSet-&gt;new(</div>
<div class="line">            xdata =&gt; \@xdata,</div>
<div class="line">            ydata =&gt; \@ydata,</div>
<div class="line">            timefmt =&gt; <span class="stringliteral">&#39;%Y-%m-%dT%H:%M:%S&#39;</span>,</div>
<div class="line">            title =&gt; $analysis_name{$sorted_analysis_ids[$i-1]},</div>
<div class="line">            style =&gt; <span class="stringliteral">&#39;filledcurves x1&#39;</span>,</div>
<div class="line">            linewidth =&gt; <span class="charliteral">&#39;0&#39;</span>,</div>
<div class="line">            color =&gt; $palette[$i-1],</div>
<div class="line">        );</div>
<div class="line">        push @datasets, $dataset;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $chart = Chart::Gnuplot-&gt;new(</div>
<div class="line">        title =&gt; sprintf(<span class="stringliteral">&#39;Profile of %s&#39;</span>, $n_relevant_analysis &lt; scalar(@sorted_analysis_ids) ? ($top &lt; 1 ? sprintf(<span class="stringliteral">&#39;%.1f%% of %s&#39;</span>, 100*$top, $url) : <span class="stringliteral">&quot;the $top top-analysis of $url&quot;</span>) : $url).($start_date ? <span class="stringliteral">&quot; from $start_date&quot;</span> : <span class="stringliteral">&quot;&quot;</span>).($end_date ? <span class="stringliteral">&quot; to $end_date&quot;</span> : <span class="stringliteral">&quot;&quot;</span>),</div>
<div class="line">        timeaxis =&gt; <span class="charliteral">&#39;x&#39;</span>,</div>
<div class="line">        legend =&gt; {</div>
<div class="line">            position =&gt; <span class="stringliteral">&#39;outside right&#39;</span>,</div>
<div class="line">            align =&gt; <span class="stringliteral">&#39;left&#39;</span>,</div>
<div class="line">        },</div>
<div class="line">        xtics =&gt; {</div>
<div class="line">            labelfmt =&gt; <span class="stringliteral">&#39;%b %d\n %H:%M&#39;</span>,</div>
<div class="line">            along =&gt; <span class="stringliteral">&#39;out nomirror&#39;</span>,</div>
<div class="line">        },</div>
<div class="line">        bg =&gt; {</div>
<div class="line">            color =&gt; <span class="stringliteral">&#39;white&#39;</span>,</div>
<div class="line">        },</div>
<div class="line">        grid =&gt; <span class="stringliteral">&#39;on&#39;</span>,</div>
<div class="line">        imagesize =&gt; <span class="stringliteral">&#39;1400, 800&#39;</span>,</div>
<div class="line">        output =&gt; $output,</div>
<div class="line">        terminal =&gt; $terminal_mapping{$gnuplot_terminal},</div>
<div class="line">        ylabel =&gt; $allowed_modes{$mode},</div>
<div class="line">        yrange =&gt; [$pseudo_zero_value, undef],</div>
<div class="line">    );</div>
<div class="line">    $chart-&gt;plot2d(@datasets);</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my ($url, $reg_conf, $reg_type, $reg_alias, $nosqlvc, $before_datetime, $days_ago);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>                      =&gt; \$url,</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span>         =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>                 =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>        =&gt; \$reg_alias,</div>
<div class="line">            <span class="stringliteral">&#39;nosqlvc=i&#39;</span>                  =&gt; \$nosqlvc,      # <span class="keyword">using</span> <span class="stringliteral">&quot;=i&quot;</span> instead of <span class="stringliteral">&quot;!&quot;</span> <span class="keywordflow">for</span> consistency with scripts where it is a propagated option</div>
<div class="line"></div>
<div class="line">                # specify the threshold datetime:</div>
<div class="line">            <span class="stringliteral">&#39;before_datetime=s&#39;</span>     =&gt; \$before_datetime,</div>
<div class="line">            <span class="stringliteral">&#39;days_ago=f&#39;</span>            =&gt; \$days_ago,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my $hive_dba;</div>
<div class="line">    <span class="keywordflow">if</span>($url or $reg_alias) {</div>
<div class="line">        $hive_dba = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">                -url                            =&gt; $url,</div>
<div class="line">                -reg_conf                       =&gt; $reg_conf,</div>
<div class="line">                -reg_type                       =&gt; $reg_type,</div>
<div class="line">                -reg_alias                      =&gt; $reg_alias,</div>
<div class="line">                -no_sql_schema_version_check    =&gt; $nosqlvc,</div>
<div class="line">        );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;\nERROR: Connection parameters (url or reg_conf+reg_alias) need to be specified\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $threshold_datetime_expression;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($before_datetime) {</div>
<div class="line">        $threshold_datetime_expression = <span class="stringliteral">&quot;&#39;$before_datetime&#39;&quot;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        unless($before_datetime or $days_ago) {</div>
<div class="line">            warn <span class="stringliteral">&quot;Neither -before_datetime or -days_ago was defined, assuming &#39;-days_ago 7&#39;\n&quot;</span>;</div>
<div class="line">            $days_ago = 7;</div>
<div class="line">        }</div>
<div class="line">        $threshold_datetime_expression = <span class="stringliteral">&quot;from_unixtime(unix_timestamp(now())-3600*24*$days_ago)&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $sql = qq{</div>
<div class="line">    DELETE j FROM job j</div>
<div class="line">     WHERE j.status=<span class="stringliteral">&#39;DONE&#39;</span></div>
<div class="line">       AND j.completed &lt; $threshold_datetime_expression</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    my $dbc = $hive_dba-&gt;dbc();</div>
<div class="line">    $dbc-&gt;do( $sql );</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my $file_or_module = shift @ARGV or script_usage(0);</div>
<div class="line"></div>
<div class="line">    my $config_module = load_file_or_module( $file_or_module );</div>
<div class="line"></div>
<div class="line">    my $config_object = $config_module-&gt;new();</div>
<div class="line">    $config_object-&gt;process_options();</div>
<div class="line">    $config_object-&gt;run();</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line"></div>
<div class="line">    my ($url, $reg_conf, $reg_type, $reg_alias, $nosqlvc, $bacct_source_line, $lsf_user, $help, $start_date, $end_date);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>                      =&gt; \$url,</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span>         =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>                 =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>        =&gt; \$reg_alias,</div>
<div class="line">            <span class="stringliteral">&#39;nosqlvc=i&#39;</span>                  =&gt; \$nosqlvc,      # <span class="keyword">using</span> <span class="stringliteral">&quot;=i&quot;</span> instead of <span class="stringliteral">&quot;!&quot;</span> <span class="keywordflow">for</span> consistency with scripts where it is a propagated option</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;dump|file=s&#39;</span>                =&gt; \$bacct_source_line,</div>
<div class="line">            <span class="stringliteral">&#39;lu|lsf_user=s&#39;</span>              =&gt; \$lsf_user,</div>
<div class="line">            <span class="stringliteral">&#39;sd|start_date=s&#39;</span>            =&gt; \$start_date,</div>
<div class="line">            <span class="stringliteral">&#39;ed|end_date=s&#39;</span>              =&gt; \$end_date,</div>
<div class="line">            <span class="stringliteral">&#39;h|help&#39;</span>                     =&gt; \$help,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($help) { script_usage(0); }</div>
<div class="line"></div>
<div class="line">    my $hive_dba;</div>
<div class="line">    <span class="keywordflow">if</span>($url or $reg_alias) {</div>
<div class="line">        $hive_dba = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">                -url                            =&gt; $url,</div>
<div class="line">                -reg_conf                       =&gt; $reg_conf,</div>
<div class="line">                -reg_type                       =&gt; $reg_type,</div>
<div class="line">                -reg_alias                      =&gt; $reg_alias,</div>
<div class="line">                -no_sql_schema_version_check    =&gt; $nosqlvc,</div>
<div class="line">        );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;\nERROR: Connection parameters (url or reg_conf+reg_alias) need to be specified\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $dbc = $hive_dba-&gt;dbc();</div>
<div class="line"></div>
<div class="line">    warn <span class="stringliteral">&quot;Creating the &#39;lsf_report&#39; table if it doesn&#39;t exist...\n&quot;</span>;</div>
<div class="line">    $dbc-&gt;do (qq{</div>
<div class="line">        CREATE TABLE IF NOT EXISTS lsf_report (</div>
<div class="line">            meadow_name      varchar(255) NOT NULL,</div>
<div class="line">            process_id       varchar(255) NOT NULL,</div>
<div class="line">            status           varchar(20) NOT NULL,</div>
<div class="line">            mem_megs         <span class="keywordtype">float</span> NOT NULL,</div>
<div class="line">            swap_megs        <span class="keywordtype">float</span> NOT NULL,</div>
<div class="line">            pending_sec      integer NOT NULL,</div>
<div class="line">            cpu_sec          <span class="keywordtype">float</span> NOT NULL,</div>
<div class="line">            lifespan_sec     integer NOT NULL,</div>
<div class="line">            exception_status varchar(40) NOT NULL,</div>
<div class="line"></div>
<div class="line">            PRIMARY KEY (meadow_name,process_id),</div>
<div class="line">            KEY process_id_idx (process_id)</div>
<div class="line"></div>
<div class="line">        ) ENGINE=InnoDB;</div>
<div class="line">    });</div>
<div class="line"></div>
<div class="line">    warn &quot;Creating the &#39;lsf_usage&#39; view if it doesn&#39;t exist...\n&quot;;</div>
<div class="line">    $dbc-&gt;do (qq{</div>
<div class="line">        CREATE OR REPLACE VIEW lsf_usage AS</div>
<div class="line">            SELECT CONCAT(logic_name,<span class="charliteral">&#39;(&#39;</span>,analysis_id,<span class="charliteral">&#39;)&#39;</span>) analysis,</div>
<div class="line">                   CONCAT(rc.name,&#39;(&#39;,rc.resource_class_id,&#39;)&#39;) resource_class,</div>
<div class="line">                   count(*) workers,</div>
<div class="line">                   min(mem_megs), avg(mem_megs), max(mem_megs),</div>
<div class="line">                   min(swap_megs), avg(swap_megs), max(swap_megs)</div>
<div class="line">            FROM analysis_base</div>
<div class="line">            JOIN resource_class rc USING(resource_class_id)</div>
<div class="line">            LEFT JOIN worker w USING(analysis_id)</div>
<div class="line">            LEFT JOIN lsf_report USING (meadow_name, process_id)</div>
<div class="line">            WHERE w.meadow_type=&#39;LSF&#39;</div>
<div class="line">            GROUP BY analysis_id</div>
<div class="line">            ORDER BY analysis_id;</div>
<div class="line">    });</div>
<div class="line"></div>
<div class="line">    my $this_lsf_farm = Bio::EnsEMBL::Hive::Meadow::LSF::name();</div>
<div class="line">    die &quot;Cannot find the name of the current farm.\n&quot; unless $this_lsf_farm;</div>
<div class="line"></div>
<div class="line">    if( $bacct_source_line &amp;&amp; -r $bacct_source_line ) {</div>
<div class="line"></div>
<div class="line">        warn <span class="stringliteral">&quot;Parsing given bacct file &#39;$bacct_source_line&#39;...\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">        warn <span class="stringliteral">&quot;No bacct information given, finding out the time interval when the pipeline was run on &#39;$this_lsf_farm&#39; ...\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">        my $offset_died_expression = ($dbc-&gt;driver eq <span class="stringliteral">&#39;sqlite&#39;</span>)</div>
<div class="line">                        ? <span class="stringliteral">&quot;datetime(max(died), &#39;+1 minute&#39;)&quot;</span></div>
<div class="line">                        : <span class="stringliteral">&quot;FROM_UNIXTIME(UNIX_TIMESTAMP(max(died))+60)&quot;</span>;</div>
<div class="line"></div>
<div class="line">        my $sth_times = $dbc-&gt;prepare( <span class="stringliteral">&quot;SELECT min(born), $offset_died_expression FROM worker WHERE meadow_type=&#39;LSF&#39; AND meadow_name=&#39;$this_lsf_farm&#39; AND status=&#39;DEAD&#39;&quot;</span> );</div>
<div class="line">        $sth_times-&gt;execute();</div>
<div class="line">        my ($from_time, $to_time) = $sth_times-&gt;fetchrow_array();</div>
<div class="line">        $sth_times-&gt;finish();</div>
<div class="line"></div>
<div class="line">        unless(defined($from_time) and defined($to_time)) {</div>
<div class="line">            die <span class="stringliteral">&quot;There seems to be no information on workers, exiting...\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (defined $start_date) {</div>
<div class="line">            die <span class="stringliteral">&quot;start_date must be in a format like &#39;2012/01/25/13:46&#39;&quot;</span> unless $start_date =~ /^\d{4}\/\d{2}\/\d{2}\/\d{2}:\d{2}$/;</div>
<div class="line">            $from_time = $start_date;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            $from_time=~s/[- ]/\<span class="comment">//g;</span></div>
<div class="line">            $from_time=~s/:\d\d$<span class="comment">//;</span></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (defined $end_date) {</div>
<div class="line">            die <span class="stringliteral">&quot;end_date must be in a format like &#39;2012/01/25/13:46&#39;&quot;</span> unless $end_date =~ /^\d{4}\/\d{2}\/\d{2}\/\d{2}:\d{2}$/;</div>
<div class="line">            $to_time = $end_date;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            $to_time=~s/[- ]/\<span class="comment">//g;</span></div>
<div class="line">            $to_time=~s/:\d\d$<span class="comment">//;</span></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        warn <span class="stringliteral">&quot;\tfrom=$from_time, to=$to_time\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">        $lsf_user = $lsf_user           ? <span class="stringliteral">&quot;-u $lsf_user&quot;</span>                : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">        my $tee   = $bacct_source_line  ? <span class="stringliteral">&quot;| tee $bacct_source_line&quot;</span>    : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">        $bacct_source_line = <span class="stringliteral">&quot;bacct -l -C $from_time,$to_time $lsf_user $tee |&quot;</span>;</div>
<div class="line"></div>
<div class="line">        warn <span class="stringliteral">&#39;Will run the following command to obtain &#39;</span>.($tee ? <span class="stringliteral">&#39;and dump &#39;</span> : <span class="stringliteral">&#39;&#39;</span>).<span class="stringliteral">&quot;bacct information: &#39;$bacct_source_line&#39; (may take a few minutes)\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $sth_replace = $dbc-&gt;prepare( <span class="stringliteral">&#39;REPLACE INTO lsf_report (meadow_name, process_id, status, mem_megs, swap_megs, pending_sec, cpu_sec, lifespan_sec, exception_status) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)&#39;</span> );</div>
<div class="line">    {</div>
<div class="line">        local $/ = <span class="stringliteral">&quot;------------------------------------------------------------------------------\n\n&quot;</span>;</div>
<div class="line">        my %units_converter = ( <span class="charliteral">&#39;K&#39;</span> =&gt; 1.0/1024, <span class="charliteral">&#39;M&#39;</span> =&gt; 1, <span class="charliteral">&#39;G&#39;</span> =&gt; 1024, <span class="charliteral">&#39;T&#39;</span> =&gt; 1024*1024 );</div>
<div class="line"></div>
<div class="line">        open(my $bacct_fh, $bacct_source_line);</div>
<div class="line">        my $record = &lt;$bacct_fh&gt;; # skip the header</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> my $record (&lt;$bacct_fh&gt;) {</div>
<div class="line">            chomp $record;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            # warn &quot;RECORD:\n$record&quot;;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            my @lines = split(/\n/, $record);</div>
<div class="line">            <span class="keywordflow">if</span>( my ($process_id) = $lines[0]=~/^Job &lt;(\d+(?:\[\d+\])?)&gt;/) {</div>
<div class="line"></div>
<div class="line">                my $exception_status = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">                <span class="keywordflow">foreach</span> (@lines) {</div>
<div class="line">                    <span class="keywordflow">if</span>(/^\s*EXCEPTION STATUS:\s*(.*?)\s*$/) {</div>
<div class="line">                        $exception_status = $1;</div>
<div class="line">                        $exception_status =~s/\s+/;/g;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                my (@keys)   = split(/\s+/, <span class="charliteral">&#39; &#39;</span>.$lines[@lines-2]);</div>
<div class="line">                my (@values) = split(/\s+/, <span class="charliteral">&#39; &#39;</span>.$lines[@lines-1]);</div>
<div class="line">                my %usage = map { ($keys[$_] =&gt; $values[$_]) } (0..@keys-1);</div>
<div class="line"></div>
<div class="line">                my ($mem_in_units, $mem_unit)   = $usage{<span class="stringliteral">&#39;MEM&#39;</span>}  =~ /^([\d\.]+)([KMGT])$/;</div>
<div class="line">                my ($swap_in_units, $swap_unit) = $usage{<span class="stringliteral">&#39;SWAP&#39;</span>} =~ /^([\d\.]+)([KMGT])$/;</div>
<div class="line"></div>
<div class="line">                my $mem_megs    = $mem_in_units  * $units_converter{$mem_unit};</div>
<div class="line">                my $swap_megs   = $swap_in_units * $units_converter{$swap_unit};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">                #warn join(&#39;, &#39;, map {sprintf(&#39;%s=%s&#39;, $_, $usage{$_})} (sort keys %usage)), &quot;\n&quot;;</span></div>
<div class="line"><span class="preprocessor"></span>                $sth_replace-&gt;execute( $this_lsf_farm, $process_id, $usage{STATUS}, $mem_megs, $swap_megs, $usage{WAIT}, $usage{CPU_T}, $usage{TURNAROUND}, $exception_status );</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        close $bacct_fh;</div>
<div class="line">    }</div>
<div class="line">    $sth_replace-&gt;finish();</div>
<div class="line">    warn <span class="stringliteral">&quot;\nReport has been loaded into pipeline&#39;s lsf_report table. Enjoy.\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my ($url, $reg_conf, $reg_type, $reg_alias, $nosqlvc, $analysis_id, $logic_name, $input_id);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>                      =&gt; \$url,</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span>         =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>                 =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>        =&gt; \$reg_alias,</div>
<div class="line">            <span class="stringliteral">&#39;nosqlvc=i&#39;</span>                  =&gt; \$nosqlvc,      # <span class="keyword">using</span> <span class="stringliteral">&quot;=i&quot;</span> instead of <span class="stringliteral">&quot;!&quot;</span> <span class="keywordflow">for</span> consistency with scripts where it is a propagated option</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                # identify the analysis:</div>
<div class="line">            <span class="stringliteral">&#39;analysis_id=i&#39;</span>         =&gt; \$analysis_id,</div>
<div class="line">            <span class="stringliteral">&#39;logic_name=s&#39;</span>          =&gt; \$logic_name,</div>
<div class="line"></div>
<div class="line">                # specify the input_id (as a <span class="keywordtype">string</span>):</div>
<div class="line">            <span class="stringliteral">&#39;input_id=s&#39;</span>            =&gt; \$input_id,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my $hive_dba;</div>
<div class="line">    <span class="keywordflow">if</span>($url or $reg_alias) {</div>
<div class="line">        $hive_dba = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">                -url                            =&gt; $url,</div>
<div class="line">                -reg_conf                       =&gt; $reg_conf,</div>
<div class="line">                -reg_type                       =&gt; $reg_type,</div>
<div class="line">                -reg_alias                      =&gt; $reg_alias,</div>
<div class="line">                -no_sql_schema_version_check    =&gt; $nosqlvc,</div>
<div class="line">        );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;\nERROR: Connection parameters (url or reg_conf+reg_alias) need to be specified\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $analysis_adaptor = $hive_dba-&gt;get_AnalysisAdaptor;</div>
<div class="line">    my $analysis; </div>
<div class="line">    <span class="keywordflow">if</span>($logic_name) {</div>
<div class="line">        $analysis = $analysis_adaptor-&gt;fetch_by_logic_name( $logic_name )</div>
<div class="line">            or die <span class="stringliteral">&quot;Could not fetch analysis &#39;$logic_name&#39;&quot;</span>;</div>
<div class="line">    } elsif($analysis_id) {</div>
<div class="line">        $analysis = $analysis_adaptor-&gt;fetch_by_dbID( $analysis_id )</div>
<div class="line">            or die <span class="stringliteral">&quot;Could not fetch analysis with dbID=&#39;$analysis_id&#39;&quot;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code" href="seed__pipeline_8pl.html#ae56eff1c83733ae5dcc4d7f7d6d25ff8">show_seedable_analyses</a>($hive_dba);</div>
<div class="line">        exit(0);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    unless($input_id) {</div>
<div class="line">        $input_id = <span class="stringliteral">&#39;{}&#39;</span>;</div>
<div class="line">        warn <span class="stringliteral">&quot;Since -input_id has not been set, assuming input_id=&#39;$input_id&#39;\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $job = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_analysis_job.html">Bio::EnsEMBL::Hive::AnalysisJob</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_storable.html#a52efcf0d0755525a7bc059b68442c620">new</a>(</div>
<div class="line">        <span class="stringliteral">&#39;prev_job_id&#39;</span>   =&gt; undef,   # <span class="keyword">this</span> job has been created by the initialization script, not by another job</div>
<div class="line">        <span class="stringliteral">&#39;analysis_id&#39;</span>   =&gt; $analysis-&gt;dbID,</div>
<div class="line">        <span class="stringliteral">&#39;input_id&#39;</span>      =&gt; destringify( $input_id ),    # Make sure all job creations undergo re-stringification to avoid alternative <span class="stringliteral">&quot;spellings&quot;</span> of the same input_id hash</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my ($job_id) = @{ $hive_dba-&gt;get_AnalysisJobAdaptor-&gt;store_jobs_and_adjust_counters( [ $job ] ) };</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($job_id) {</div>
<div class="line"></div>
<div class="line">        print <span class="stringliteral">&quot;Job $job_id [ &quot;</span>.$analysis-&gt;logic_name.<span class="charliteral">&#39;(&#39;</span>.$analysis-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_storable.html#a5e5743dee1414d2c0dec45b5a5d42216">dbID</a>.<span class="stringliteral">&quot;)] : &#39;$input_id&#39;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">        warn <span class="stringliteral">&quot;Could not create job &#39;$input_id&#39; (it may have been created already)\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
<a class="anchor" id="af314298b28a69538fb25aa7eb1327c98"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public run_autonomously </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-run_autonomously" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-run_autonomously-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_autonomously-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_autonomously-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#af314298b28a69538fb25aa7eb1327c98">run_autonomously</a> {</div>
<div class="line">    my ($self, $max_loops, $keep_alive, $queen, $valley, $run_analysis, $run_job_id, $force) = @_;</div>
<div class="line"></div>
<div class="line">    my $resourceless_worker_cmd = <a class="code" href="beekeeper_8pl.html#ad7de8680eb8b39e160cee04957ccd668">generate_worker_cmd</a>($self, $run_analysis, $run_job_id, $force);</div>
<div class="line">    my $special_task            = $run_analysis || $run_job_id;</div>
<div class="line"></div>
<div class="line">    my $rc_id2name  = $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_ResourceClassAdaptor-&gt;fetch_HASHED_FROM_resource_class_id_TO_name();</div>
<div class="line">    my %meadow_type_rc_name2resource_param_list = ();</div>
<div class="line">    <span class="keywordflow">foreach</span> my $rd (@{ $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_ResourceDescriptionAdaptor-&gt;fetch_all() }) {</div>
<div class="line">        $meadow_type_rc_name2resource_param_list{ $rd-&gt;meadow_type() }{ $rc_id2name-&gt;{$rd-&gt;resource_class_id} } = [ $rd-&gt;submission_cmd_args, $rd-&gt;worker_cmd_args ];</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $beekeeper_pid = $$;</div>
<div class="line"></div>
<div class="line">    my $iteration=0;</div>
<div class="line">    my $num_of_remaining_jobs=0;</div>
<div class="line">    my $failed_analyses=0;</div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        <span class="keywordflow">if</span>($iteration++) {</div>
<div class="line">            $queen-&gt;monitor();</div>
<div class="line">            $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;dbc-&gt;disconnect_if_idle;</div>
<div class="line">            printf(<span class="stringliteral">&quot;sleep %.2f minutes. Next loop at %s\n&quot;</span>, $self-&gt;{<span class="stringliteral">&#39;sleep_minutes&#39;</span>}, scalar localtime(time+$self-&gt;{<span class="stringliteral">&#39;sleep_minutes&#39;</span>}*60));</div>
<div class="line">            sleep($self-&gt;{<span class="stringliteral">&#39;sleep_minutes&#39;</span>}*60);  </div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        print(<span class="stringliteral">&quot;\n======= beekeeper loop ** $iteration **==========\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">        $queen-&gt;check_for_dead_workers($valley, 0);</div>
<div class="line"></div>
<div class="line">        $queen-&gt;print_analysis_status unless($self-&gt;{<span class="stringliteral">&#39;no_analysis_stats&#39;</span>});</div>
<div class="line">        $queen-&gt;print_running_worker_counts;</div>
<div class="line"></div>
<div class="line">        my $workers_to_submit_by_meadow_type_rc_name</div>
<div class="line">            = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a65f7b429d0ffbda238faeda2451350a8">Bio::EnsEMBL::Hive::Scheduler::schedule_workers_resync_if_necessary</a>($queen, $valley, $run_analysis);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( keys %$workers_to_submit_by_meadow_type_rc_name ) {</div>
<div class="line"></div>
<div class="line">            my $submit_log_subdir;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>( $self-&gt;{<span class="stringliteral">&#39;submit_log_dir&#39;</span>} ) {</div>
<div class="line">                $submit_log_subdir = $self-&gt;{<span class="stringliteral">&#39;submit_log_dir&#39;</span>}.<span class="stringliteral">&quot;/submit_bk${beekeeper_pid}_iter${iteration}&quot;</span>;</div>
<div class="line">                make_path( $submit_log_subdir );</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">foreach</span> my $meadow_type (keys %$workers_to_submit_by_meadow_type_rc_name) {</div>
<div class="line"></div>
<div class="line">                my $this_meadow = $valley-&gt;available_meadow_hash-&gt;{$meadow_type};</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">foreach</span> my $rc_name (keys %{ $workers_to_submit_by_meadow_type_rc_name-&gt;{$meadow_type} }) {</div>
<div class="line">                    my $this_meadow_rc_worker_count = $workers_to_submit_by_meadow_type_rc_name-&gt;{$meadow_type}{$rc_name};</div>
<div class="line"></div>
<div class="line">                    print <span class="stringliteral">&quot;Submitting $this_meadow_rc_worker_count workers (rc_name=$rc_name) to &quot;</span>.$this_meadow-&gt;signature().<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">                    my ($submission_cmd_args, $worker_cmd_args) = @{ $meadow_type_rc_name2resource_param_list{ $meadow_type }{ $rc_name } || [] };</div>
<div class="line"></div>
<div class="line">                    my $specific_worker_cmd = $resourceless_worker_cmd</div>
<div class="line">                                            . ($special_task ? <span class="stringliteral">&#39;&#39;</span> : <span class="stringliteral">&quot; -rc_name $rc_name&quot;</span>)</div>
<div class="line">                                            . (defined($worker_cmd_args) ? <span class="stringliteral">&quot; $worker_cmd_args&quot;</span> : <span class="stringliteral">&#39;&#39;</span>);</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">if</span>( $self-&gt;{<span class="stringliteral">&#39;submit_log_dir&#39;</span>} ) {</div>
<div class="line">                        $self-&gt;{<span class="stringliteral">&#39;submit_stdout_file&#39;</span>} = $submit_log_subdir . <span class="stringliteral">&quot;/log_${rc_name}_%J_%I.out&quot;</span>;</div>
<div class="line">                        $self-&gt;{<span class="stringliteral">&#39;submit_stderr_file&#39;</span>} = $submit_log_subdir . <span class="stringliteral">&quot;/log_${rc_name}_%J_%I.err&quot;</span>;</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    $this_meadow-&gt;submit_workers($specific_worker_cmd, $this_meadow_rc_worker_count, $iteration,</div>
<div class="line">                                                    $rc_name, $submission_cmd_args || <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line">                                                    $self-&gt;{<span class="stringliteral">&#39;submit_stdout_file&#39;</span>}, $self-&gt;{<span class="stringliteral">&#39;submit_stderr_file&#39;</span>});</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            print <span class="stringliteral">&quot;Not submitting any workers this iteration\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        $failed_analyses       = $queen-&gt;get_num_failed_analyses($run_analysis);</div>
<div class="line">        $num_of_remaining_jobs = $queen-&gt;get_remaining_jobs_show_hive_progress();</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">while</span>( $keep_alive</div>
<div class="line">            or (!$failed_analyses and $num_of_remaining_jobs and $iteration!=$max_loops) );</div>
<div class="line"></div>
<div class="line">    print <span class="stringliteral">&quot;The Beekeeper has stopped because &quot;</span>.(</div>
<div class="line">          $failed_analyses ? <span class="stringliteral">&quot;there were $failed_analyses failed analyses&quot;</span></div>
<div class="line">        : !$num_of_remaining_jobs ? <span class="stringliteral">&quot;there is nothing left to do&quot;</span></div>
<div class="line">        : <span class="stringliteral">&quot;the number of loops was limited by $max_loops and this limit expired&quot;</span></div>
<div class="line">    ).<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;dbc %d disconnect cycles\n&quot;</span>, $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;dbc-&gt;disconnect_count);</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_54316937a66070d9897b24579a7d39ac.html">scripts</a></li><li class="navelem"><a class="el" href="beekeeper_8pl.html">beekeeper.pl</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
