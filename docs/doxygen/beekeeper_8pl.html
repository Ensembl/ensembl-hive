<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ensembl-hive: scripts/beekeeper.pl File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ensembl-hive
   &#160;<span id="projectnumber">2.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('beekeeper_8pl.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">beekeeper.pl File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a3ce8b237b3bdb2817dac6f769e5768c2"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> ()</td></tr>
<tr class="separator:a3ce8b237b3bdb2817dac6f769e5768c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad7de8680eb8b39e160cee04957ccd668"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="beekeeper_8pl.html#ad7de8680eb8b39e160cee04957ccd668">generate_worker_cmd</a> ()</td></tr>
<tr class="separator:ad7de8680eb8b39e160cee04957ccd668"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af314298b28a69538fb25aa7eb1327c98"><td class="memItemLeft" align="right" valign="top">public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="beekeeper_8pl.html#af314298b28a69538fb25aa7eb1327c98">run_autonomously</a> ()</td></tr>
<tr class="separator:af314298b28a69538fb25aa7eb1327c98"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ad7de8680eb8b39e160cee04957ccd668"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public generate_worker_cmd </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-generate_worker_cmd" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-generate_worker_cmd-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-generate_worker_cmd-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-generate_worker_cmd-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#ad7de8680eb8b39e160cee04957ccd668">generate_worker_cmd</a> {</div>
<div class="line">    my ($self, $analyses_pattern, $run_job_id, $force) = @_;</div>
<div class="line"></div>
<div class="line">    my $worker_cmd = $ENV{<span class="stringliteral">&#39;EHIVE_ROOT_DIR&#39;</span>}.<span class="stringliteral">&#39;/scripts/runWorker.pl&#39;</span>;</div>
<div class="line"></div>
<div class="line">    unless(-x $worker_cmd) {</div>
<div class="line">        print(<span class="stringliteral">&quot;Can&#39;t run &#39;$worker_cmd&#39; script for some reason, please investigate.\n&quot;</span>);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $worker_option (<span class="stringliteral">&#39;url&#39;</span>, <span class="stringliteral">&#39;reg_conf&#39;</span>, <span class="stringliteral">&#39;reg_type&#39;</span>, <span class="stringliteral">&#39;reg_alias&#39;</span>, <span class="stringliteral">&#39;nosqlvc&#39;</span>, <span class="stringliteral">&#39;job_limit&#39;</span>, <span class="stringliteral">&#39;life_span&#39;</span>, <span class="stringliteral">&#39;retry_throwing_jobs&#39;</span>, <span class="stringliteral">&#39;can_respecialize&#39;</span>, <span class="stringliteral">&#39;hive_log_dir&#39;</span>, <span class="stringliteral">&#39;debug&#39;</span>) {</div>
<div class="line">        <span class="keywordflow">if</span>(defined(my $value = $self-&gt;{$worker_option})) {</div>
<div class="line">            $worker_cmd .= <span class="stringliteral">&quot; -${worker_option} $value&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        # special task:</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> ($run_job_id) {</div>
<div class="line">        $worker_cmd .= <span class="stringliteral">&quot; -job_id $run_job_id&quot;</span>;</div>
<div class="line">    } elsif ($analyses_pattern) {</div>
<div class="line">        $worker_cmd .= <span class="stringliteral">&quot; -analyses_pattern &#39;&quot;</span>.$analyses_pattern.<span class="stringliteral">&quot;&#39;&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (defined($force)) {</div>
<div class="line">        $worker_cmd .= <span class="stringliteral">&quot; -force $force&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $worker_cmd;</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
<a class="anchor" id="a3ce8b237b3bdb2817dac6f769e5768c2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public main </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    $| = 1;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        # ok this is a hack, but I&#39;m going to pretend I&#39;ve got an object here</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        # by creating a hash ref and passing it around like an object</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        # this is to avoid using global variables in functions, and to consolidate</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        # the globals into a nice &#39;$self&#39; package</span></div>
<div class="line"><span class="preprocessor"></span>    my $self = {};</div>
<div class="line"></div>
<div class="line">    my $help                        = 0;</div>
<div class="line">    my $report_versions             = 0;</div>
<div class="line">    my $loopit                      = 0;</div>
<div class="line">    my $sync                        = 0;</div>
<div class="line">    my $local                       = 0;</div>
<div class="line">    my $show_failed_jobs            = 0;</div>
<div class="line">    my $default_meadow_type         = undef;</div>
<div class="line">    my $submit_workers_max          = undef;</div>
<div class="line">    my $total_running_workers_max   = undef;</div>
<div class="line">    my $submission_options          = undef;</div>
<div class="line">    my $run                         = 0;</div>
<div class="line">    my $max_loops                   = 0; # not running by <span class="keywordflow">default</span></div>
<div class="line">    my $run_job_id                  = undef;</div>
<div class="line">    my $force                       = undef;</div>
<div class="line">    my $keep_alive                  = 0; # ==1 means run even when there is nothing to <span class="keywordflow">do</span></div>
<div class="line">    my $check_for_dead              = 0;</div>
<div class="line">    my $bury_unkwn_workers          = 0;</div>
<div class="line">    my $all_dead                    = 0;</div>
<div class="line">    my $balance_semaphores          = 0;</div>
<div class="line">    my $job_id_for_output           = 0;</div>
<div class="line">    my $show_worker_stats           = 0;</div>
<div class="line">    my $kill_worker_id              = 0;</div>
<div class="line">    my $reset_job_id                = 0;</div>
<div class="line">    my $reset_all_jobs_for_analysis = 0;        # DEPRECATED</div>
<div class="line">    my $reset_failed_jobs_for_analysis = 0;     # DEPRECATED</div>
<div class="line">    my $reset_all_jobs              = 0;</div>
<div class="line">    my $reset_failed_jobs           = 0;</div>
<div class="line"></div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;url&#39;</span>}                  = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;reg_conf&#39;</span>}             = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;reg_type&#39;</span>}             = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;reg_alias&#39;</span>}            = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;nosqlvc&#39;</span>}              = undef;</div>
<div class="line"></div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;config_files&#39;</span>}         = [];</div>
<div class="line"></div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;sleep_minutes&#39;</span>}        = 1;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;retry_throwing_jobs&#39;</span>}  = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;can_respecialize&#39;</span>}     = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;hive_log_dir&#39;</span>}         = undef;</div>
<div class="line">    $self-&gt;{<span class="stringliteral">&#39;submit_log_dir&#39;</span>}       = undef;</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                    # connection parameters</div>
<div class="line">               <span class="stringliteral">&#39;url=s&#39;</span>              =&gt; \$self-&gt;{<span class="stringliteral">&#39;url&#39;</span>},</div>
<div class="line">               <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span> =&gt; \$self-&gt;{<span class="stringliteral">&#39;reg_conf&#39;</span>},</div>
<div class="line">               <span class="stringliteral">&#39;reg_type=s&#39;</span>         =&gt; \$self-&gt;{<span class="stringliteral">&#39;reg_type&#39;</span>},</div>
<div class="line">               <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>=&gt; \$self-&gt;{<span class="stringliteral">&#39;reg_alias&#39;</span>},</div>
<div class="line">               <span class="stringliteral">&#39;nosqlvc=i&#39;</span>          =&gt; \$self-&gt;{<span class="stringliteral">&#39;nosqlvc&#39;</span>},     # can<span class="stringliteral">&#39;t use the binary &quot;!&quot; as it is a propagated option</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    # json config files</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>config_file=s@<span class="stringliteral">&#39;     =&gt; $self-&gt;{&#39;</span>config_files<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    # loop control</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>run<span class="stringliteral">&#39;                =&gt; \$run,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>loop<span class="stringliteral">&#39;               =&gt; \$loopit,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>max_loops=i<span class="stringliteral">&#39;        =&gt; \$max_loops,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>keep_alive<span class="stringliteral">&#39;         =&gt; \$keep_alive,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>job_id|run_job_id=i<span class="stringliteral">&#39;=&gt; \$run_job_id,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>force=i<span class="stringliteral">&#39;            =&gt; \$force,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>sleep=f<span class="stringliteral">&#39;            =&gt; \$self-&gt;{&#39;</span>sleep_minutes<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    # meadow control</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>local!<span class="stringliteral">&#39;                         =&gt; \$local,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>meadow_type=s<span class="stringliteral">&#39;                  =&gt; \$default_meadow_type,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>total_running_workers_max=i<span class="stringliteral">&#39;    =&gt; \$total_running_workers_max,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>submit_workers_max=i<span class="stringliteral">&#39;           =&gt; \$submit_workers_max,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>submission_options=s<span class="stringliteral">&#39;           =&gt; \$submission_options,</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    # worker control</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>job_limit=i<span class="stringliteral">&#39;            =&gt; \$self-&gt;{&#39;</span>job_limit<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>life_span|lifespan=i<span class="stringliteral">&#39;   =&gt; \$self-&gt;{&#39;</span>life_span<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>logic_name=s<span class="stringliteral">&#39;           =&gt; \$self-&gt;{&#39;</span>logic_name<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>analyses_pattern=s<span class="stringliteral">&#39;     =&gt; \$self-&gt;{&#39;</span>analyses_pattern<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>hive_log_dir|hive_output_dir=s<span class="stringliteral">&#39;      =&gt; \$self-&gt;{&#39;</span>hive_log_dir<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>retry_throwing_jobs=i<span class="stringliteral">&#39;  =&gt; \$self-&gt;{&#39;</span>retry_throwing_jobs<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>can_respecialize=i<span class="stringliteral">&#39;     =&gt; \$self-&gt;{&#39;</span>can_respecialize<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>debug=i<span class="stringliteral">&#39;                =&gt; \$self-&gt;{&#39;</span>debug<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>submit_log_dir=s<span class="stringliteral">&#39;       =&gt; \$self-&gt;{&#39;</span>submit_log_dir<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    # other commands/options</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>h|help!<span class="stringliteral">&#39;           =&gt; \$help,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>v|versions!<span class="stringliteral">&#39;       =&gt; \$report_versions,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>sync!<span class="stringliteral">&#39;             =&gt; \$sync,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>dead!<span class="stringliteral">&#39;             =&gt; \$check_for_dead,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>unkwn!<span class="stringliteral">&#39;            =&gt; \$bury_unkwn_workers,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>killworker=i<span class="stringliteral">&#39;      =&gt; \$kill_worker_id,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>alldead!<span class="stringliteral">&#39;          =&gt; \$all_dead,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>balance_semaphores<span class="stringliteral">&#39;=&gt; \$balance_semaphores,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>no_analysis_stats<span class="stringliteral">&#39; =&gt; \$self-&gt;{&#39;</span>no_analysis_stats<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>worker_stats<span class="stringliteral">&#39;      =&gt; \$show_worker_stats,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>failed_jobs<span class="stringliteral">&#39;       =&gt; \$show_failed_jobs,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>reset_job_id=i<span class="stringliteral">&#39;    =&gt; \$reset_job_id,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>reset_failed_jobs_for_analysis=s<span class="stringliteral">&#39; =&gt; \$reset_failed_jobs_for_analysis,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>reset_all_jobs_for_analysis=s<span class="stringliteral">&#39; =&gt; \$reset_all_jobs_for_analysis,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>reset_failed_jobs<span class="stringliteral">&#39; =&gt; \$reset_failed_jobs,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>reset_all_jobs<span class="stringliteral">&#39;    =&gt; \$reset_all_jobs,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>job_output=i<span class="stringliteral">&#39;      =&gt; \$job_id_for_output,</span></div>
<div class="line"><span class="stringliteral">    );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if ($help) { script_usage(0); }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($report_versions) {</span></div>
<div class="line"><span class="stringliteral">        report_versions();</span></div>
<div class="line"><span class="stringliteral">        exit(0);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $config = Bio::EnsEMBL::Hive::Utils::Config-&gt;new(@{$self-&gt;{&#39;</span>config_files<span class="stringliteral">&#39;}});</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($run or $run_job_id) {</span></div>
<div class="line"><span class="stringliteral">        $max_loops = 1;</span></div>
<div class="line"><span class="stringliteral">    } elsif ($loopit or $keep_alive) {</span></div>
<div class="line"><span class="stringliteral">        unless($max_loops) {</span></div>
<div class="line"><span class="stringliteral">            $max_loops = -1; # unlimited</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($self-&gt;{&#39;</span>url<span class="stringliteral">&#39;} or $self-&gt;{&#39;</span>reg_alias<span class="stringliteral">&#39;}) {</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;{&#39;</span>dba<span class="stringliteral">&#39;} = Bio::EnsEMBL::Hive::DBSQL::DBAdaptor-&gt;new(</span></div>
<div class="line"><span class="stringliteral">            -url                            =&gt; $self-&gt;{&#39;</span>url<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">            -reg_conf                       =&gt; $self-&gt;{&#39;</span>reg_conf<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">            -reg_type                       =&gt; $self-&gt;{&#39;</span>reg_type<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">            -reg_alias                      =&gt; $self-&gt;{&#39;</span>reg_alias<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">            -no_sql_schema_version_check    =&gt; $self-&gt;{&#39;</span>nosqlvc<span class="stringliteral">&#39;},</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral">    } else {</span></div>
<div class="line"><span class="stringliteral">        print &quot;\nERROR : Connection parameters (url or reg_conf+reg_alias) need to be specified\n\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        script_usage(1);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if( $self-&gt;{&#39;</span>url<span class="stringliteral">&#39;} ) {    # protect the URL that we pass to Workers by hiding the password in %ENV:</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;{&#39;</span>url<span class="stringliteral">&#39;} = &quot;&#39;</span><span class="stringliteral">&quot;. $self-&gt;{&#39;dba&#39;}-&gt;dbc-&gt;url(&#39;EHIVE_PASS&#39;) .&quot;</span><span class="stringliteral">&#39;&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $queen = $self-&gt;{&#39;</span>dba<span class="stringliteral">&#39;}-&gt;get_Queen;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $pipeline_name = $self-&gt;{&#39;</span>dba<span class="stringliteral">&#39;}-&gt;get_MetaAdaptor-&gt;get_value_by_key( &#39;</span>hive_pipeline_name<span class="stringliteral">&#39; );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($pipeline_name) {</span></div>
<div class="line"><span class="stringliteral">        warn &quot;Pipeline name: $pipeline_name\n&quot;;</span></div>
<div class="line"><span class="stringliteral">    } else {</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;+---------------------------------------------------------------------+\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;!                                                                     !\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;!                  WARNING:                                           !\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;!                                                                     !\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;! At the moment your pipeline doesn&#39;</span>t have <span class="stringliteral">&#39;pipeline_name&#39;</span> defined.   !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>! This may seriously impair your beekeeping experience unless you are !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>! the only farm user. The name should be set in your PipeConfig file, !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>! or <span class="keywordflow">if</span> you are running an old pipeline you can just set it by hand   !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>! in the <span class="stringliteral">&#39;meta&#39;</span> table.                                                !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>!                                                                     !\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        print STDERR &quot;</span>+---------------------------------------------------------------------+\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($run_job_id) {</span></div>
<div class="line"><span class="stringliteral">        $submit_workers_max = 1;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $default_meadow_type = &#39;LOCAL&#39; if($local);</span></div>
<div class="line"><span class="stringliteral">    my $valley = Bio::EnsEMBL::Hive::Valley-&gt;new( $config, $default_meadow_type, $pipeline_name );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my ($beekeeper_meadow_type, $beekeeper_meadow_name) = $valley-&gt;whereami();</span></div>
<div class="line"><span class="stringliteral">    unless($beekeeper_meadow_type eq &#39;LOCAL&#39;) {</span></div>
<div class="line"><span class="stringliteral">        die &quot;</span>beekeeper.pl detected it has been itself submitted to <span class="stringliteral">&#39;$beekeeper_meadow_type/$beekeeper_meadow_name&#39;</span>, but <span class="keyword">this</span> mode of operation is not supported.\n<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">           .&quot;</span>Please just run beekeeper.pl on a farm head node, preferably from under a <span class="stringliteral">&#39;screen&#39;</span> session.\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $valley-&gt;config_set(&#39;SubmitWorkersMax&#39;, $submit_workers_max) if(defined $submit_workers_max);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $default_meadow = $valley-&gt;get_default_meadow();</span></div>
<div class="line"><span class="stringliteral">    warn &quot;</span>Default meadow: <span class="stringliteral">&quot;.$default_meadow-&gt;signature.&quot;</span>\n\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $default_meadow-&gt;config_set(&#39;TotalRunningWorkersMax&#39;, $total_running_workers_max) if(defined $total_running_workers_max);</span></div>
<div class="line"><span class="stringliteral">    $default_meadow-&gt;config_set(&#39;SubmissionOptions&#39;, $submission_options) if(defined $submission_options);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($reset_job_id) { $queen-&gt;reset_job_by_dbID_and_sync($reset_job_id); }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($job_id_for_output) {</span></div>
<div class="line"><span class="stringliteral">        printf(&quot;</span>===== job output\n<span class="stringliteral">&quot;);</span></div>
<div class="line"><span class="stringliteral">        my $job = $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisJobAdaptor-&gt;fetch_by_dbID($job_id_for_output);</span></div>
<div class="line"><span class="stringliteral">        print $job-&gt;toString. &quot;</span>\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($reset_all_jobs_for_analysis) {</span></div>
<div class="line"><span class="stringliteral">        die &quot;</span>Deprecated option -reset_all_jobs_for_analysis. Please use -reset_all_jobs in combination with -analyses_pattern &lt;pattern&gt;<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral">    if($reset_failed_jobs_for_analysis) {</span></div>
<div class="line"><span class="stringliteral">        die &quot;</span>Deprecated option -reset_failed_jobs_for_analysis. Please use -reset_failed_jobs in combination with -analyses_pattern &lt;pattern&gt;<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if ($kill_worker_id) {</span></div>
<div class="line"><span class="stringliteral">        my $kill_worker = $queen-&gt;fetch_by_dbID($kill_worker_id)</span></div>
<div class="line"><span class="stringliteral">            or die &quot;</span>Could not fetch worker with dbID=<span class="stringliteral">&#39;$kill_worker_id&#39;</span> to kill<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        unless( $kill_worker-&gt;cause_of_death() ) {</span></div>
<div class="line"><span class="stringliteral">            if( my $meadow = $valley-&gt;find_available_meadow_responsible_for_worker( $kill_worker ) ) {</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                if( $meadow-&gt;check_worker_is_alive_and_mine ) {</span></div>
<div class="line"><span class="stringliteral">                    printf(&quot;</span>Killing worker: %10d %35s %15s  %20s(%d) : <span class="stringliteral">&quot;, </span></div>
<div class="line"><span class="stringliteral">                            $kill_worker-&gt;dbID, $kill_worker-&gt;host, $kill_worker-&gt;process_id, </span></div>
<div class="line"><span class="stringliteral">                            $kill_worker-&gt;analysis-&gt;logic_name, $kill_worker-&gt;analysis_id);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                    $meadow-&gt;kill_worker($kill_worker);</span></div>
<div class="line"><span class="stringliteral">                    $kill_worker-&gt;cause_of_death(&#39;KILLED_BY_USER&#39;);</span></div>
<div class="line"><span class="stringliteral">                    $queen-&gt;register_worker_death($kill_worker);</span></div>
<div class="line"><span class="stringliteral">                         # what about clean-up? Should we do it here or not?</span></div>
<div class="line"><span class="stringliteral">                } else {</span></div>
<div class="line"><span class="stringliteral">                    die &quot;</span>According to the Meadow, the Worker (dbID=$kill_worker_id) is not running, so cannot kill<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">                }</span></div>
<div class="line"><span class="stringliteral">            } else {</span></div>
<div class="line"><span class="stringliteral">                die &quot;</span>Cannot access the Meadow responsible for the Worker (dbID=$kill_worker_id), so cannot kill<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">        } else {</span></div>
<div class="line"><span class="stringliteral">            die &quot;</span>According to the Queen, the Worker (dbID=$kill_worker_id) is not running, so cannot kill<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if( $self-&gt;{&#39;logic_name&#39;} ) {   # FIXME: for now, logic_name will override analysis_pattern quietly</span></div>
<div class="line"><span class="stringliteral">        warn &quot;</span>-logic_name is now deprecated, please use -analyses_pattern that extends the functionality of -logic_name .\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;{&#39;analyses_pattern&#39;} = $self-&gt;{&#39;logic_name&#39;};</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $run_job;</span></div>
<div class="line"><span class="stringliteral">    if($run_job_id) {</span></div>
<div class="line"><span class="stringliteral">        $run_job = $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisJobAdaptor-&gt;fetch_by_dbID( $run_job_id )</span></div>
<div class="line"><span class="stringliteral">            or die &quot;</span>Could not fetch Job with dbID=$run_job_id.\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $list_of_analyses = $run_job</span></div>
<div class="line"><span class="stringliteral">        ? [ $run_job-&gt;analysis ]</span></div>
<div class="line"><span class="stringliteral">        : $self-&gt;{&#39;dba&#39;}-&gt;get_AnalysisAdaptor-&gt;fetch_all_by_pattern( $self-&gt;{&#39;analyses_pattern&#39;} );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if( $self-&gt;{&#39;analyses_pattern&#39;} ) {</span></div>
<div class="line"><span class="stringliteral">        if( @$list_of_analyses ) {</span></div>
<div class="line"><span class="stringliteral">            print &quot;</span>Beekeeper : the following Analyses matched your -analysis_pattern <span class="stringliteral">&#39;&quot;.$self-&gt;{&#39;</span>analyses_pattern<span class="stringliteral">&#39;}.&quot;&#39;</span> : <span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">                .join(&#39;, &#39;, map { $_-&gt;logic_name.&#39;(&#39;.$_-&gt;dbID.&#39;)&#39; } @$list_of_analyses).&quot;</span>\n\n<span class="stringliteral">&quot;;</span></div>
<div class="line"><span class="stringliteral">        } else {</span></div>
<div class="line"><span class="stringliteral">            die &quot;</span>Beekeeper : the -analyses_pattern <span class="stringliteral">&#39;&quot;.$self-&gt;{&#39;</span>analyses_pattern<span class="stringliteral">&#39;}.&quot;&#39;</span> did not match any Analyses.\n<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($reset_all_jobs || $reset_failed_jobs) {</span></div>
<div class="line"><span class="stringliteral">        if ($reset_all_jobs and not $self-&gt;{&#39;analyses_pattern&#39;}) {</span></div>
<div class="line"><span class="stringliteral">            die &quot;</span>Beekeeper : do you really want to reset *all* the jobs ? If yes, add \<span class="stringliteral">&quot;-analyses_pattern &#39;%&#39;\&quot; to the command line\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_AnalysisJobAdaptor-&gt;reset_jobs_for_analysis_id( $list_of_analyses, $reset_all_jobs ); </div>
<div class="line">        $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_Queen-&gt;synchronize_hive( $list_of_analyses );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($all_dead)           { $queen-&gt;register_all_workers_dead(); }</div>
<div class="line">    <span class="keywordflow">if</span>($check_for_dead)     { $queen-&gt;check_for_dead_workers($valley, 1); }</div>
<div class="line">    <span class="keywordflow">if</span>($bury_unkwn_workers) { $queen-&gt;check_for_dead_workers($valley, 1, 1); }</div>
<div class="line">    <span class="keywordflow">if</span>($balance_semaphores) { $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_AnalysisJobAdaptor-&gt;balance_semaphores( $list_of_analyses ); }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($max_loops) { # positive $max_loop means limited, negative means unlimited</div>
<div class="line"></div>
<div class="line">        <a class="code" href="beekeeper_8pl.html#af314298b28a69538fb25aa7eb1327c98">run_autonomously</a>($self, $max_loops, $keep_alive, $queen, $valley, $list_of_analyses, $self-&gt;{<span class="stringliteral">&#39;analyses_pattern&#39;</span>}, $run_job_id, $force);</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">            # the output of several methods will look differently depending on $analysis being [un]defined</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        <span class="keywordflow">if</span>($sync) {</div>
<div class="line">            $queen-&gt;synchronize_hive( $list_of_analyses );</div>
<div class="line">        }</div>
<div class="line">        print $queen-&gt;print_status_and_return_reasons_to_exit( $list_of_analyses, !$self-&gt;{<span class="stringliteral">&#39;no_analysis_stats&#39;</span>} );</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>($show_worker_stats) {</div>
<div class="line">            print <span class="stringliteral">&quot;\n===== List of live Workers according to the Queen: ======\n&quot;</span>;</div>
<div class="line">            <span class="keywordflow">foreach</span> my $worker (@{ $queen-&gt;fetch_overdue_workers(0) }) {</div>
<div class="line">                print $worker-&gt;toString(1).<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_RoleAdaptor-&gt;print_active_role_counts;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a65f7b429d0ffbda238faeda2451350a8">Bio::EnsEMBL::Hive::Scheduler::schedule_workers_resync_if_necessary</a>($queen, $valley, $list_of_analyses);   # show what would be submitted, but <span class="keywordflow">do</span> not actually submit</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>($show_failed_jobs) {</div>
<div class="line">            print(<span class="stringliteral">&quot;===== failed jobs\n&quot;</span>);</div>
<div class="line">            my $failed_job_list = $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_AnalysisJobAdaptor-&gt;fetch_all_by_analysis_id_status( $self-&gt;{<span class="stringliteral">&#39;logic_name&#39;</span>} and $list_of_analyses , <span class="stringliteral">&#39;FAILED&#39;</span>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">foreach</span> my $job (@{$failed_job_list}) {</div>
<div class="line">                print $job-&gt;toString. <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    exit(0);</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my ($reg_conf, $reg_type, $reg_alias, $executable, $url, @prepend, @append, $sqlcmd, $verbose, $help, $report_versions);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf=s&#39;</span>        =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>        =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias=s&#39;</span>       =&gt; \$reg_alias,</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;exec|executable=s&#39;</span> =&gt; \$executable,</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>             =&gt; \$url,</div>
<div class="line">            <span class="stringliteral">&#39;prepend=s@&#39;</span>        =&gt; \@prepend,</div>
<div class="line">            <span class="stringliteral">&#39;append|extra=s@&#39;</span>   =&gt; \@append,</div>
<div class="line">            <span class="stringliteral">&#39;sqlcmd=s&#39;</span>          =&gt; \$sqlcmd,</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;verbose!&#39;</span>          =&gt; \$verbose,</div>
<div class="line">            <span class="stringliteral">&#39;help!&#39;</span>             =&gt; \$help,</div>
<div class="line">            <span class="stringliteral">&#39;v|versions!&#39;</span>       =&gt; \$report_versions,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my $dbc;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($help) {</div>
<div class="line"></div>
<div class="line">        script_usage(0);</div>
<div class="line"></div>
<div class="line">    } elsif($report_versions) {</div>
<div class="line"></div>
<div class="line">        report_versions();</div>
<div class="line">        exit(0);</div>
<div class="line"></div>
<div class="line">    } elsif($reg_alias) {</div>
<div class="line">        script_usage(1) if $url;</div>
<div class="line"></div>
<div class="line">        require Bio::EnsEMBL::Registry;</div>
<div class="line">        Bio::EnsEMBL::Registry-&gt;load_all($reg_conf);</div>
<div class="line"></div>
<div class="line">        my $species = Bio::EnsEMBL::Registry-&gt;get_alias($reg_alias)</div>
<div class="line">            || die &quot;Could not solve the alias &#39;$reg_alias&#39;&quot;.($reg_conf ? &quot; via the registry file &#39;$reg_conf&#39;&quot; : &quot;&quot;);</div>
<div class="line"></div>
<div class="line">        my $dba;</div>
<div class="line">        if ($reg_type) {</div>
<div class="line">            $dba = Bio::EnsEMBL::Registry-&gt;get_DBAdaptor($species, $reg_type)</div>
<div class="line">                || die <span class="stringliteral">&quot;Could not find any database for &#39;$species&#39; (alias: &#39;$reg_alias&#39;) with the type &#39;$reg_type&#39;&quot;</span>.($reg_conf ? <span class="stringliteral">&quot; via the registry file &#39;$reg_conf&#39;&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"></div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">            my $dbas = Bio::EnsEMBL::Registry-&gt;get_all_DBAdaptors(-species =&gt; $species);</div>
<div class="line">            <span class="keywordflow">if</span> (scalar(@$dbas) == 0) {</div>
<div class="line"><span class="preprocessor">                # I think this case cannot happen: if there are no databases, the alias does not exist and get_alias() should have failed</span></div>
<div class="line"><span class="preprocessor"></span>                die <span class="stringliteral">&quot;Could not find any database for &#39;$species&#39; (alias: &#39;$reg_alias&#39;)&quot;</span>.($reg_conf ? <span class="stringliteral">&quot; via the registry file &#39;$reg_conf&#39;&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"></div>
<div class="line">            } elsif (scalar(@$dbas) &gt;= 2) {</div>
<div class="line">                die <span class="stringliteral">&quot;There are several databases for &#39;$species&#39; (alias: &#39;$reg_alias&#39;). Please set -reg_type to one of: &quot;</span>.join(<span class="stringliteral">&quot;, &quot;</span>, map {$_-&gt;group} @$dbas);</div>
<div class="line">            };</div>
<div class="line">            $dba = $dbas-&gt;[0];</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        $dbc = bless $dba-&gt;dbc, <span class="stringliteral">&#39;Bio::EnsEMBL::Hive::DBSQL::DBConnection&#39;</span>;</div>
<div class="line"></div>
<div class="line">    } elsif($url) {</div>
<div class="line">        $dbc = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_connection.html">Bio::EnsEMBL::Hive::DBSQL::DBConnection</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_connection.html#a7931542229862db93f899aef0eb983f0">new</a>( -url =&gt; $url );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (@append) {</div>
<div class="line">        warn qq{In db_cmd.pl, <span class="keyword">final</span> arguments don<span class="stringliteral">&#39;t have to be declared with --append any more. All the remaining arguments are considered to be appended.\n};</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my @cmd = @{ $dbc-&gt;to_cmd( $executable, \@prepend, [@append, @ARGV], $sqlcmd ) };</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if( $verbose ) {</span></div>
<div class="line"><span class="stringliteral">        my $flat_cmd = join(&#39;</span> <span class="stringliteral">&#39;, map { ($_=~/^-?\w+$/) ? $_ : &quot;\&quot;$_\&quot;&quot; } @cmd);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        warn &quot;\nThe actual command I am running is:\n\t$flat_cmd\n\n&quot;;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    exec(@cmd);</span></div>
<div class="line"><span class="stringliteral">}</span></div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line"></div>
<div class="line">    my $self = {};</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">            # connection parameters</div>
<div class="line">        <span class="stringliteral">&#39;url=s&#39;</span>                 =&gt; \$self-&gt;{<span class="stringliteral">&#39;url&#39;</span>},</div>
<div class="line">        <span class="stringliteral">&#39;reg_conf|reg_file=s&#39;</span>   =&gt; \$self-&gt;{<span class="stringliteral">&#39;reg_conf&#39;</span>},</div>
<div class="line">        <span class="stringliteral">&#39;reg_type=s&#39;</span>            =&gt; \$self-&gt;{<span class="stringliteral">&#39;reg_type&#39;</span>},</div>
<div class="line">        <span class="stringliteral">&#39;reg_alias|reg_name=s&#39;</span>  =&gt; \$self-&gt;{<span class="stringliteral">&#39;reg_alias&#39;</span>},</div>
<div class="line">        <span class="stringliteral">&#39;nosqlvc=i&#39;</span>             =&gt; \$self-&gt;{<span class="stringliteral">&#39;nosqlvc&#39;</span>},     # <span class="keyword">using</span> <span class="stringliteral">&quot;=i&quot;</span> instead of <span class="stringliteral">&quot;!&quot;</span> <span class="keywordflow">for</span> consistency with scripts where it is a propagated option</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            # json config files</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="stringliteral">&#39;config_file=s@&#39;</span>        =&gt; \$self-&gt;{<span class="stringliteral">&#39;config_files&#39;</span>},</div>
<div class="line"></div>
<div class="line">        <span class="stringliteral">&#39;pipeconfig|pc=s@&#39;</span>      =&gt; \$self-&gt;{<span class="stringliteral">&#39;pipeconfigs&#39;</span>}, # now an array</div>
<div class="line"></div>
<div class="line">        <span class="stringliteral">&#39;f|format=s&#39;</span>            =&gt; \$self-&gt;{<span class="stringliteral">&#39;format&#39;</span>},</div>
<div class="line">        <span class="stringliteral">&#39;o|out|output=s&#39;</span>        =&gt; \$self-&gt;{<span class="stringliteral">&#39;output&#39;</span>},</div>
<div class="line"></div>
<div class="line">        <span class="stringliteral">&#39;h|help&#39;</span>                =&gt; \$self-&gt;{<span class="stringliteral">&#39;help&#39;</span>},</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($self-&gt;{<span class="stringliteral">&#39;help&#39;</span>}) {</div>
<div class="line">        pod2usage({-exitvalue =&gt; 0, -verbose =&gt; 2});</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(! $self-&gt;{<span class="stringliteral">&#39;output&#39;</span>}) {</div>
<div class="line">        pod2usage({</div>
<div class="line">            -message =&gt; <span class="stringliteral">&#39;ERROR: No -output flag given&#39;</span>,</div>
<div class="line">            -exitvalue =&gt; 1,</div>
<div class="line">            -verbose =&gt; 2</div>
<div class="line">        });</div>
<div class="line">    }</div>
<div class="line">  </div>
<div class="line">    <span class="keywordflow">if</span>(!$self-&gt;{<span class="stringliteral">&#39;format&#39;</span>}) {</div>
<div class="line">        <span class="keywordflow">if</span>($self-&gt;{<span class="stringliteral">&#39;output&#39;</span>}=~/\.(\w+)$/) {</div>
<div class="line">            $self-&gt;{<span class="stringliteral">&#39;format&#39;</span>} = $1;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            die <span class="stringliteral">&quot;Format was not set and could not guess from &quot;</span>.$self-&gt;{<span class="stringliteral">&#39;output&#39;</span>}.<span class="stringliteral">&quot;. Please use either way to select it.\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($self-&gt;{<span class="stringliteral">&#39;url&#39;</span>} or $self-&gt;{<span class="stringliteral">&#39;reg_alias&#39;</span>}) {</div>
<div class="line">        $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>} = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">            -url                            =&gt; $self-&gt;{<span class="stringliteral">&#39;url&#39;</span>},</div>
<div class="line">            -reg_conf                       =&gt; $self-&gt;{<span class="stringliteral">&#39;reg_conf&#39;</span>},</div>
<div class="line">            -reg_type                       =&gt; $self-&gt;{<span class="stringliteral">&#39;reg_type&#39;</span>},</div>
<div class="line">            -reg_alias                      =&gt; $self-&gt;{<span class="stringliteral">&#39;reg_alias&#39;</span>},</div>
<div class="line">            -no_sql_schema_version_check    =&gt; $self-&gt;{<span class="stringliteral">&#39;nosqlvc&#39;</span>},</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;load_collections();</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">        <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#a45d333f0553191bff073966ff1d0aa53">init_collections</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($self-&gt;{<span class="stringliteral">&#39;pipeconfigs&#39;</span>}) {</div>
<div class="line">        <span class="keywordflow">foreach</span> my $pipeconfig (@{ $self-&gt;{<span class="stringliteral">&#39;pipeconfigs&#39;</span>} }) {</div>
<div class="line">            my $pipeconfig_package_name = load_file_or_module( $pipeconfig );</div>
<div class="line"></div>
<div class="line">            my $pipeconfig_object = $pipeconfig_package_name-&gt;new();</div>
<div class="line">            $pipeconfig_object-&gt;process_options( 0 );</div>
<div class="line"></div>
<div class="line">            $pipeconfig_object-&gt;add_objects_from_config();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $graph = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_utils_1_1_graph.html">Bio::EnsEMBL::Hive::Utils::Graph</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_utils_1_1_graph.html#a0452e8098246f27173059b14600f190c">new</a>(</div>
<div class="line">        $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>},</div>
<div class="line">        $self-&gt;{<span class="stringliteral">&#39;config_files&#39;</span>} ? @{ $self-&gt;{<span class="stringliteral">&#39;config_files&#39;</span>} } : ()</div>
<div class="line">    );</div>
<div class="line">    my $graphviz = $graph-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_utils_1_1_graph.html#ad7fad3a0d313ae9d07c6b6e636876109">build</a>();</div>
<div class="line"></div>
<div class="line">    my $call = <span class="stringliteral">&#39;as_&#39;</span>.$self-&gt;{<span class="stringliteral">&#39;format&#39;</span>};</div>
<div class="line"></div>
<div class="line">    $graphviz-&gt;$call($self-&gt;{<span class="stringliteral">&#39;output&#39;</span>});</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line"></div>
<div class="line">    my ($url, $reg_conf, $reg_type, $reg_alias, $nosqlvc, $help, $verbose, $mode, $start_date, $end_date, $output, $top, $default_memory, $default_cores, $key);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>                      =&gt; \$url,</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span>         =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>                 =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>        =&gt; \$reg_alias,</div>
<div class="line">            <span class="stringliteral">&#39;nosqlvc=i&#39;</span>                  =&gt; \$nosqlvc,      # <span class="keyword">using</span> <span class="stringliteral">&quot;=i&quot;</span> instead of <span class="stringliteral">&quot;!&quot;</span> <span class="keywordflow">for</span> consistency with scripts where it is a propagated option</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;verbose!&#39;</span>                   =&gt; \$verbose,</div>
<div class="line">            <span class="stringliteral">&#39;h|help&#39;</span>                     =&gt; \$help,</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;start_date=s&#39;</span>               =&gt; \$start_date,</div>
<div class="line">            <span class="stringliteral">&#39;end_date=s&#39;</span>                 =&gt; \$end_date,</div>
<div class="line">            <span class="stringliteral">&#39;mode=s&#39;</span>                     =&gt; \$mode,</div>
<div class="line">            <span class="stringliteral">&#39;key=s&#39;</span>                      =&gt; \$key,</div>
<div class="line">            <span class="stringliteral">&#39;top=f&#39;</span>                      =&gt; \$top,</div>
<div class="line">            <span class="stringliteral">&#39;mem=i&#39;</span>                      =&gt; \$default_memory,</div>
<div class="line">            <span class="stringliteral">&#39;n_core=i&#39;</span>                   =&gt; \$default_cores,</div>
<div class="line">            <span class="stringliteral">&#39;output=s&#39;</span>                   =&gt; \$output,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($help) { script_usage(0); }</div>
<div class="line"></div>
<div class="line">    my $hive_dba;</div>
<div class="line">    <span class="keywordflow">if</span>($url or $reg_alias) {</div>
<div class="line">        $hive_dba = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">                -url                            =&gt; $url,</div>
<div class="line">                -reg_conf                       =&gt; $reg_conf,</div>
<div class="line">                -reg_type                       =&gt; $reg_type,</div>
<div class="line">                -reg_alias                      =&gt; $reg_alias,</div>
<div class="line">                -no_sql_schema_version_check    =&gt; $nosqlvc,</div>
<div class="line">        );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;\nERROR: Connection parameters (url or reg_conf+reg_alias) need to be specified\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Check whether $mode is valid</span></div>
<div class="line"><span class="preprocessor"></span>    my %allowed_modes = (</div>
<div class="line">        workers =&gt; <span class="stringliteral">&#39;Number of workers&#39;</span>,</div>
<div class="line">        memory =&gt; <span class="stringliteral">&#39;Memory asked / unused (Gb)&#39;</span>,</div>
<div class="line">        cores =&gt; <span class="stringliteral">&#39;Number of CPU cores asked / unused&#39;</span>,</div>
<div class="line">        pending_workers =&gt; <span class="stringliteral">&#39;Number of pending workers&#39;</span>,</div>
<div class="line">        pending_time =&gt; <span class="stringliteral">&#39;Average instantaneous pending time (min.)&#39;</span>,</div>
<div class="line">    );</div>
<div class="line">    <span class="keywordflow">if</span> ($mode) {</div>
<div class="line">        die <span class="stringliteral">&quot;Unknown mode &#39;$mode&#39;. Allowed modes are: &quot;</span>.join(<span class="stringliteral">&quot;, &quot;</span>, keys %allowed_modes) unless exists $allowed_modes{$mode};</div>
<div class="line">        $default_memory = 100 unless $default_memory;</div>
<div class="line">        $default_cores = 1 unless $default_cores;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        $mode = <span class="stringliteral">&#39;workers&#39;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my %allowed_keys = (</div>
<div class="line">        analysis =&gt; <span class="stringliteral">&#39;Analysis&#39;</span>,</div>
<div class="line">        resource_class =&gt; <span class="stringliteral">&#39;Resource class&#39;</span>,</div>
<div class="line">    );</div>
<div class="line">    <span class="keywordflow">if</span> ($key) {</div>
<div class="line">        die <span class="stringliteral">&quot;Unknown key &#39;$key&#39;. Allowed keys are: &quot;</span>.join(<span class="stringliteral">&quot;, &quot;</span>, keys %allowed_keys) unless exists $allowed_keys{$key};</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        $key = <span class="stringliteral">&#39;analysis&#39;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Palette generated with R: c(brewer.pal(9, &quot;Set1&quot;), brewer.pal(12, &quot;Set3&quot;)). #FFFFB3 is removed because it is too close to white</span></div>
<div class="line"><span class="preprocessor"></span>    my @palette = qw(#E41A1C #377EB8 #4DAF4A #984EA3 #FF7F00 #FFFF33 #A65628 #F781BF #999999     #8DD3C7 #BEBADA #FB8072 #80B1D3 #FDB462 #B3DE69 #FCCDE5 #D9D9D9 #BC80BD #CCEBC5 #FFED6F    #2F4F4F);</div>
<div class="line"></div>
<div class="line">    my %terminal_mapping = (</div>
<div class="line">        <span class="stringliteral">&#39;emf&#39;</span> =&gt; <span class="stringliteral">&#39;emf&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;png&#39;</span> =&gt; <span class="stringliteral">&#39;png&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;svg&#39;</span> =&gt; <span class="stringliteral">&#39;svg&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;jpg&#39;</span> =&gt; <span class="stringliteral">&#39;jpeg&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;gif&#39;</span> =&gt; <span class="stringliteral">&#39;gif&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;ps&#39;</span>  =&gt; <span class="stringliteral">&#39;postscript eps enhanced color&#39;</span>,</div>
<div class="line">        <span class="stringliteral">&#39;pdf&#39;</span> =&gt; <span class="stringliteral">&#39;pdf color enhanced&#39;</span>,</div>
<div class="line">    );</div>
<div class="line">    my $gnuplot_terminal = undef;</div>
<div class="line">    <span class="keywordflow">if</span> ($output and $output =~ /\.(\w+)$/) {</div>
<div class="line">        $gnuplot_terminal = $1;</div>
<div class="line">        die <span class="stringliteral">&quot;The format &#39;$gnuplot_terminal&#39; is not currently supported.&quot;</span> <span class="keywordflow">if</span> not exists $terminal_mapping{$gnuplot_terminal};</div>
<div class="line">        require Chart::Gnuplot;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    my $dbh = $hive_dba-&gt;dbc-&gt;db_handle();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Get the memory usage from each resource_class</span></div>
<div class="line"><span class="preprocessor"></span>    my %mem_resources = ();</div>
<div class="line">    my %cpu_resources = ();</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">foreach</span> my $rd (@{$hive_dba-&gt;get_ResourceDescriptionAdaptor-&gt;fetch_all()}) {</div>
<div class="line">            <span class="keywordflow">if</span> ($rd-&gt;meadow_type eq <span class="stringliteral">&#39;LSF&#39;</span>) {</div>
<div class="line">                $mem_resources{$rd-&gt;resource_class_id} = $1 <span class="keywordflow">if</span> $rd-&gt;submission_cmd_args =~ m/mem=(\d+)/;</div>
<div class="line">                $cpu_resources{$rd-&gt;resource_class_id} = $1 <span class="keywordflow">if</span> $rd-&gt;submission_cmd_args =~ m/-n\s*(\d+)/;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    warn <span class="stringliteral">&quot;mem_resources: &quot;</span>, Dumper \%mem_resources <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    warn <span class="stringliteral">&quot;cpu_resources: &quot;</span>, Dumper \%cpu_resources <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">    my $additive_layer = (($mode eq <span class="stringliteral">&#39;memory&#39;</span>) or ($mode eq <span class="stringliteral">&#39;cores&#39;</span>)) ? 1 : 0;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Get the resource usage information of each worker</span></div>
<div class="line"><span class="preprocessor"></span>    my %used_res = ();</div>
<div class="line">    <span class="keywordflow">if</span> (($mode eq <span class="stringliteral">&#39;memory&#39;</span>) or ($mode eq <span class="stringliteral">&#39;cores&#39;</span>) or ($mode eq <span class="stringliteral">&#39;pending_workers&#39;</span>) or ($mode eq <span class="stringliteral">&#39;pending_time&#39;</span>)) {</div>
<div class="line">        my $sql_used_res = <span class="stringliteral">&#39;SELECT worker_id, mem_megs, cpu_sec/lifespan_sec, pending_sec FROM worker_resource_usage&#39;</span>;</div>
<div class="line">        <span class="keywordflow">foreach</span> my $db_entry (@{$dbh-&gt;selectall_arrayref($sql_used_res)}) {</div>
<div class="line">            my $worker_id = shift @$db_entry;</div>
<div class="line">            $used_res{$worker_id} = $db_entry;</div>
<div class="line">        }</div>
<div class="line">        warn scalar(keys %used_res), <span class="stringliteral">&quot; worker info loaded from worker_resource_usage\n&quot;</span> <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Get the info about the analysis</span></div>
<div class="line"><span class="preprocessor"></span>    my $analysis_adaptor        = $hive_dba-&gt;get_AnalysisAdaptor;</div>
<div class="line">    my %default_resource_class  = %{ $analysis_adaptor-&gt;fetch_HASHED_FROM_analysis_id_TO_resource_class_id() };</div>
<div class="line">    my $rc_adaptor              = $hive_dba-&gt;get_ResourceClassAdaptor;</div>
<div class="line">    warn <span class="stringliteral">&quot;default_resource_class: &quot;</span>, Dumper \%default_resource_class <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    my %key_name = %{$key eq <span class="stringliteral">&#39;analysis&#39;</span></div>
<div class="line">        ? $analysis_adaptor-&gt;fetch_HASHED_FROM_analysis_id_TO_logic_name()</div>
<div class="line">        : $rc_adaptor-&gt;fetch_HASHED_FROM_resource_class_id_TO_name()</div>
<div class="line">    };</div>
<div class="line">    $key_name{-1} = <span class="stringliteral">&#39;UNSPECIALIZED&#39;</span>;</div>
<div class="line">    warn scalar(keys %key_name), <span class="stringliteral">&quot; keys: &quot;</span>, Dumper \%key_name <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Get the events from the database</span></div>
<div class="line"><span class="preprocessor"></span>    my %events = ();</div>
<div class="line">    my %layers = ();</div>
<div class="line">    {</div>
<div class="line">        my $sql = $key eq <span class="stringliteral">&#39;analysis&#39;</span></div>
<div class="line">            ? <span class="stringliteral">&#39;SELECT when_born, when_died, worker_id, resource_class_id, analysis_id FROM worker LEFT JOIN role USING (worker_id)&#39;</span></div>
<div class="line">            : <span class="stringliteral">&#39;SELECT when_born, when_died, worker_id, resource_class_id FROM worker&#39;</span>;</div>
<div class="line">        my @tmp_dates = @{$dbh-&gt;selectall_arrayref($sql)};</div>
<div class="line">        warn scalar(@tmp_dates), <span class="stringliteral">&quot; rows\n&quot;</span> <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">foreach</span> my $db_entry (@tmp_dates) {</div>
<div class="line">            my ($when_born, $when_died, $worker_id, $resource_class_id, $analysis_id) = @$db_entry;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            # In case $resource_class_id is undef</span></div>
<div class="line"><span class="preprocessor"></span>            next unless $resource_class_id or $analysis_id;</div>
<div class="line">            $resource_class_id  <span class="comment">//= $default_resource_class{$analysis_id};</span></div>
<div class="line">            my $key_value = $key eq <span class="stringliteral">&#39;analysis&#39;</span> ? $analysis_id : $resource_class_id;</div>
<div class="line">            $key_value = -1 <span class="keywordflow">if</span> not defined $key_value;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> ($mode eq <span class="stringliteral">&#39;workers&#39;</span>) {</div>
<div class="line">                <a class="code" href="generate__timeline_8pl.html#af9173ecf6f7c033aa8704be6d5aa1019">add_event</a>(\%events, $key_value, $when_born, $when_died, 1);</div>
<div class="line"></div>
<div class="line">            } elsif ($mode eq <span class="stringliteral">&#39;memory&#39;</span>) {</div>
<div class="line">                my $offset = ($mem_resources{$resource_class_id} || $default_memory) / 1024.;</div>
<div class="line">                <a class="code" href="generate__timeline_8pl.html#af9173ecf6f7c033aa8704be6d5aa1019">add_event</a>(\%events, $key_value, $when_born, $when_died, $offset);</div>
<div class="line">                $offset = ($used_res{$worker_id}-&gt;[0]) / 1024. <span class="keywordflow">if</span> exists $used_res{$worker_id} and $used_res{$worker_id}-&gt;[0];</div>
<div class="line">                <a class="code" href="generate__timeline_8pl.html#af9173ecf6f7c033aa8704be6d5aa1019">add_event</a>(\%layers, $key_value, $when_born, $when_died, $offset);</div>
<div class="line"></div>
<div class="line">            } elsif ($mode eq <span class="stringliteral">&#39;cores&#39;</span>) {</div>
<div class="line">                my $offset = ($cpu_resources{$resource_class_id} || $default_cores);</div>
<div class="line">                <a class="code" href="generate__timeline_8pl.html#af9173ecf6f7c033aa8704be6d5aa1019">add_event</a>(\%events, $key_value, $when_born, $when_died, $offset);</div>
<div class="line">                $offset = $used_res{$worker_id}-&gt;[1] <span class="keywordflow">if</span> exists $used_res{$worker_id} and $used_res{$worker_id}-&gt;[1];</div>
<div class="line">                <a class="code" href="generate__timeline_8pl.html#af9173ecf6f7c033aa8704be6d5aa1019">add_event</a>(\%layers, $key_value, $when_born, $when_died, $offset);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keywordflow">if</span> (exists $used_res{$worker_id} and $used_res{$worker_id}-&gt;[2]) {</div>
<div class="line">                    my $pending_sec = $used_res{$worker_id}-&gt;[2];</div>
<div class="line">                    <a class="code" href="generate__timeline_8pl.html#af9173ecf6f7c033aa8704be6d5aa1019">add_event</a>(\%events, $key_value, -$pending_sec, $when_born, 1);</div>
<div class="line">                    <a class="code" href="generate__timeline_8pl.html#af9173ecf6f7c033aa8704be6d5aa1019">add_event</a>(\%layers, $key_value, -$pending_sec, $when_born, $pending_sec/60);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    warn <span class="stringliteral">&quot;Events recorded: &quot;</span>, scalar(keys %events), <span class="stringliteral">&quot; &quot;</span>, scalar(keys %layers), <span class="stringliteral">&quot;\n&quot;</span> <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">    my @event_dates = sort {$a cmp $b} (keys %events);</div>
<div class="line"></div>
<div class="line">    my $time_samples_data = <a class="code" href="generate__timeline_8pl.html#a75fd23e351a53d15c7ab4af9ed65ac5f">cumulate_events</a>(\%events, [keys %key_name], $start_date, $end_date, \%events, $verbose);</div>
<div class="line">    my %tot_analysis = %{$time_samples_data-&gt;[0]};</div>
<div class="line">    my @xdata        = map {$_-&gt;[0]} @{$time_samples_data-&gt;[1]};</div>
<div class="line">    my @data_timings = map {$_-&gt;[1]} @{$time_samples_data-&gt;[1]};</div>
<div class="line">    my $max_workers  =   $time_samples_data-&gt;[2];</div>
<div class="line"></div>
<div class="line">    my $total_total = sum(values %tot_analysis);</div>
<div class="line"></div>
<div class="line">    my @sorted_key_ids = sort {($tot_analysis{$b} &lt;=&gt; $tot_analysis{$a}) || (lc $key_name{$a} cmp lc $key_name{$b})} (grep {$tot_analysis{$_}} keys %tot_analysis);</div>
<div class="line">    warn <span class="stringliteral">&quot;Sorted key_ids: &quot;</span>, Dumper \@sorted_key_ids <span class="keywordflow">if</span> $verbose;</div>
<div class="line">    warn Dumper([map {$key_name{$_}} @sorted_key_ids]) <span class="keywordflow">if</span> $verbose;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (not $gnuplot_terminal) {</div>
<div class="line">        print join(<span class="stringliteral">&quot;\t&quot;</span>, <span class="stringliteral">&#39;date&#39;</span>, <span class="stringliteral">&quot;OVERALL_$mode&quot;</span>, map {$key_name{$_}} @sorted_key_ids), <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        print join(<span class="stringliteral">&quot;\t&quot;</span>, <span class="stringliteral">&#39;total&#39;</span>, $total_total, map {$tot_analysis{$_}} @sorted_key_ids), <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        print join(<span class="stringliteral">&quot;\t&quot;</span>, <span class="stringliteral">&#39;proportion&#39;</span>, <span class="stringliteral">&#39;NA&#39;</span>, map {$tot_analysis{$_}/$total_total} @sorted_key_ids), <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        my $s = 0;</div>
<div class="line">        print join(<span class="stringliteral">&quot;\t&quot;</span>, <span class="stringliteral">&#39;cum_proportion&#39;</span>, <span class="stringliteral">&#39;NA&#39;</span>, map {$s+=$tot_analysis{$_}/$total_total} @sorted_key_ids), <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">foreach</span> my $row (@{$time_samples_data-&gt;[1]}) {</div>
<div class="line">            print join(<span class="stringliteral">&quot;\t&quot;</span>, $row-&gt;[0], sum(values %{$row-&gt;[1]}), map {$row-&gt;[1]-&gt;{$_}} @sorted_key_ids).<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $layer_samples_data = <a class="code" href="generate__timeline_8pl.html#a75fd23e351a53d15c7ab4af9ed65ac5f">cumulate_events</a>(\%layers, [keys %key_name], $start_date, $end_date, \%events, $verbose);</div>
<div class="line">    my @layer_timings = map {$_-&gt;[1]} @{$layer_samples_data-&gt;[1]};</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($mode eq <span class="stringliteral">&#39;pending_time&#39;</span>) {</div>
<div class="line">        <span class="keywordflow">foreach</span> my $j (1..(scalar(@data_timings))) {</div>
<div class="line">            <span class="keywordflow">foreach</span> my $i (@sorted_key_ids) {</div>
<div class="line">                next <span class="keywordflow">if</span> $data_timings[$j-1]-&gt;{$i} == 0;</div>
<div class="line">                $data_timings[$j-1]-&gt;{$i} = $layer_timings[$j-1]-&gt;{$i} / $data_timings[$j-1]-&gt;{$i};</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my ($n_relevant_analysis, $need_other_analysis, $real_top) = <a class="code" href="generate__timeline_8pl.html#ac70218a8fce3a55255272b1552f00d3e">count_number_relevant_sets</a>(\@sorted_key_ids, \%tot_analysis, $total_total, $top, scalar(@palette), $verbose);</div>
<div class="line"></div>
<div class="line">    my @datasets = ();</div>
<div class="line"></div>
<div class="line">    my $pseudo_zero_value = -$max_workers / 50;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # The background plot: the sum of all the analysis</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> ($need_other_analysis) {</div>
<div class="line">        <a class="code" href="generate__timeline_8pl.html#ae26789977ae8553649b15f0935dbba69">add_dataset</a>(\@datasets, \@data_timings, \@layer_timings, \@xdata,</div>
<div class="line">            \@sorted_key_ids, <span class="stringliteral">&#39;OTHER&#39;</span>, $palette[$n_relevant_analysis], $pseudo_zero_value, $additive_layer ? [@sorted_key_ids[$n_relevant_analysis..(scalar(@sorted_key_ids)-1)]] : undef);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Each analysis is plotted as the sum of itself and the top ones</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $i (reverse 1..$n_relevant_analysis) {</div>
<div class="line">        <a class="code" href="generate__timeline_8pl.html#ae26789977ae8553649b15f0935dbba69">add_dataset</a>(\@datasets, \@data_timings, \@layer_timings, \@xdata,</div>
<div class="line">            [@sorted_key_ids[0..($i-1)]], $key_name{$sorted_key_ids[$i-1]}, $palette[$i-1], $pseudo_zero_value, $additive_layer ? [$sorted_key_ids[$i-1]] : undef);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # The main Gnuplot object</span></div>
<div class="line"><span class="preprocessor"></span>    my $chart = Chart::Gnuplot-&gt;new(</div>
<div class="line">        title =&gt; sprintf(<span class="stringliteral">&#39;Profile of %s%s&#39;</span>, $n_relevant_analysis &lt; scalar(@sorted_key_ids) ? sprintf(<span class="stringliteral">&#39;the %s top-analysis of &#39;</span>, $real_top ? ($real_top &lt; 1 ? sprintf(<span class="stringliteral">&#39;%.1f%%&#39;</span>, 100*$real_top) : $real_top) : $n_relevant_analysis) : <span class="stringliteral">&#39;&#39;</span>, $url)</div>
<div class="line">                 .($start_date ? <span class="stringliteral">&quot; from $start_date&quot;</span> : <span class="stringliteral">&quot;&quot;</span>).($end_date ? <span class="stringliteral">&quot; to $end_date&quot;</span> : <span class="stringliteral">&quot;&quot;</span>),</div>
<div class="line">        timeaxis =&gt; <span class="charliteral">&#39;x&#39;</span>,</div>
<div class="line">        legend =&gt; {</div>
<div class="line">            position =&gt; <span class="stringliteral">&#39;outside right&#39;</span>,</div>
<div class="line">            align =&gt; <span class="stringliteral">&#39;left&#39;</span>,</div>
<div class="line">        },</div>
<div class="line">        xtics =&gt; {</div>
<div class="line">            labelfmt =&gt; <span class="stringliteral">&#39;%b %d\n %H:%M&#39;</span>,</div>
<div class="line">            along =&gt; <span class="stringliteral">&#39;out nomirror&#39;</span>,</div>
<div class="line">        },</div>
<div class="line">        bg =&gt; {</div>
<div class="line">            color =&gt; <span class="stringliteral">&#39;white&#39;</span>,</div>
<div class="line">        },</div>
<div class="line">        grid =&gt; <span class="stringliteral">&#39;on&#39;</span>,</div>
<div class="line">        imagesize =&gt; <span class="stringliteral">&#39;1400, 800&#39;</span>,</div>
<div class="line">        output =&gt; $output,</div>
<div class="line">        terminal =&gt; $terminal_mapping{$gnuplot_terminal},</div>
<div class="line">        ylabel =&gt; $allowed_modes{$mode},</div>
<div class="line">        yrange =&gt; [$pseudo_zero_value, undef],</div>
<div class="line">    );</div>
<div class="line">    $chart-&gt;plot2d(@datasets);</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my ($url, $reg_conf, $reg_type, $reg_alias, $nosqlvc, $before_datetime, $days_ago);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>                      =&gt; \$url,</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span>         =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>                 =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>        =&gt; \$reg_alias,</div>
<div class="line">            <span class="stringliteral">&#39;nosqlvc=i&#39;</span>                  =&gt; \$nosqlvc,      # <span class="keyword">using</span> <span class="stringliteral">&quot;=i&quot;</span> instead of <span class="stringliteral">&quot;!&quot;</span> <span class="keywordflow">for</span> consistency with scripts where it is a propagated option</div>
<div class="line"></div>
<div class="line">                # specify the threshold datetime:</div>
<div class="line">            <span class="stringliteral">&#39;before_datetime=s&#39;</span>     =&gt; \$before_datetime,</div>
<div class="line">            <span class="stringliteral">&#39;days_ago=f&#39;</span>            =&gt; \$days_ago,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my $hive_dba;</div>
<div class="line">    <span class="keywordflow">if</span>($url or $reg_alias) {</div>
<div class="line">        $hive_dba = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">                -url                            =&gt; $url,</div>
<div class="line">                -reg_conf                       =&gt; $reg_conf,</div>
<div class="line">                -reg_type                       =&gt; $reg_type,</div>
<div class="line">                -reg_alias                      =&gt; $reg_alias,</div>
<div class="line">                -no_sql_schema_version_check    =&gt; $nosqlvc,</div>
<div class="line">        );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;\nERROR: Connection parameters (url or reg_conf+reg_alias) need to be specified\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $threshold_datetime_expression;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($before_datetime) {</div>
<div class="line">        $threshold_datetime_expression = <span class="stringliteral">&quot;&#39;$before_datetime&#39;&quot;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        unless($before_datetime or $days_ago) {</div>
<div class="line">            warn <span class="stringliteral">&quot;Neither -before_datetime or -days_ago was defined, assuming &#39;-days_ago 7&#39;\n&quot;</span>;</div>
<div class="line">            $days_ago = 7;</div>
<div class="line">        }</div>
<div class="line">        $threshold_datetime_expression = <span class="stringliteral">&quot;from_unixtime(unix_timestamp(now())-3600*24*$days_ago)&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $sql = qq{</div>
<div class="line">    DELETE j FROM job j</div>
<div class="line">     WHERE j.status=<span class="stringliteral">&#39;DONE&#39;</span></div>
<div class="line">       AND j.when_completed &lt; $threshold_datetime_expression</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    my $dbc = $hive_dba-&gt;dbc();</div>
<div class="line">    $dbc-&gt;do( $sql );</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my %deprecated_option = ();</div>
<div class="line">    GetOptions( \%deprecated_option,</div>
<div class="line">        <span class="stringliteral">&#39;analysis_topup!&#39;</span>,  # always on</div>
<div class="line">        <span class="stringliteral">&#39;job_topup!&#39;</span>,       # never, use seed_pipeline.pl</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($deprecated_option{<span class="stringliteral">&#39;job_topup&#39;</span>}) {</div>
<div class="line">        die <span class="stringliteral">&quot;-job_topup mode has been discontinued. Please use seed_pipeline.pl instead.\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span>($deprecated_option{<span class="stringliteral">&#39;analysis_topup&#39;</span>}) {</div>
<div class="line">        die <span class="stringliteral">&quot;-analysis_topup has been deprecated. Please note this script now *always* runs in -analysis_topup mode.\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $file_or_module = shift @ARGV or script_usage(0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scripts_1_1_init_pipeline.html#a20ae94e5207096eb0b868d9bd1525008">Bio::EnsEMBL::Hive::Scripts::InitPipeline::init_pipeline</a>($file_or_module);</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line"></div>
<div class="line">    my ($url, $reg_conf, $reg_type, $reg_alias, $nosqlvc, $source_line, $username, $help);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>                 =&gt; \$url,</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span>    =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>            =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>   =&gt; \$reg_alias,</div>
<div class="line">            <span class="stringliteral">&#39;nosqlvc=i&#39;</span>             =&gt; \$nosqlvc,       # <span class="keyword">using</span> <span class="stringliteral">&quot;=i&quot;</span> instead of <span class="stringliteral">&quot;!&quot;</span> <span class="keywordflow">for</span> consistency with scripts where it is a propagated option</div>
<div class="line"></div>
<div class="line">            <span class="stringliteral">&#39;username=s&#39;</span>            =&gt; \$username,      # say <span class="stringliteral">&quot;-user all&quot;</span> <span class="keywordflow">if</span> the pipeline was run by several people</div>
<div class="line">            <span class="stringliteral">&#39;source_line=s&#39;</span>         =&gt; \$source_line,</div>
<div class="line">            <span class="stringliteral">&#39;h|help&#39;</span>                =&gt; \$help,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($help) { script_usage(0); }</div>
<div class="line"></div>
<div class="line">    my $hive_dba;</div>
<div class="line">    <span class="keywordflow">if</span>($url or $reg_alias) {</div>
<div class="line">        $hive_dba = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">                -url                            =&gt; $url,</div>
<div class="line">                -reg_conf                       =&gt; $reg_conf,</div>
<div class="line">                -reg_type                       =&gt; $reg_type,</div>
<div class="line">                -reg_alias                      =&gt; $reg_alias,</div>
<div class="line">                -no_sql_schema_version_check    =&gt; $nosqlvc,</div>
<div class="line">        );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;\nERROR: Connection parameters (url or reg_conf+reg_alias) need to be specified\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $queen = $hive_dba-&gt;get_Queen;</div>
<div class="line">    my $meadow_2_pid_wid = $queen-&gt;fetch_HASHED_FROM_meadow_type_AND_meadow_name_AND_process_id_TO_worker_id();</div>
<div class="line"></div>
<div class="line">    my $valley = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_valley.html">Bio::EnsEMBL::Hive::Valley</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_valley.html#a51140e4714459dccef65cb34d97bfe13">new</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( $source_line ) {</div>
<div class="line"></div>
<div class="line">        my $meadow = $valley-&gt;get_available_meadow_list()-&gt;[0];</div>
<div class="line">        warn <span class="stringliteral">&quot;Taking the resource_usage data from the source ( $source_line ), assuming Meadow &quot;</span>.$meadow-&gt;signature.<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(my $report_entries = $meadow-&gt;parse_report_source_line( $source_line ) ) {</div>
<div class="line">            $queen-&gt;store_resource_usage( $report_entries, $meadow_2_pid_wid-&gt;{$meadow-&gt;type}{$meadow-&gt;cached_name} );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;Searching for Workers without known resource_usage...\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">        my $meadow_2_interval = $queen-&gt;interval_workers_with_unknown_usage();</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">foreach</span> my $meadow (@{ $valley-&gt;get_available_meadow_list() }) {</div>
<div class="line"></div>
<div class="line">            warn <span class="stringliteral">&quot;\nFinding out the time interval when the pipeline was run on Meadow &quot;</span>.$meadow-&gt;signature.<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>(my $our_interval = $meadow_2_interval-&gt;{ $meadow-&gt;type }{ $meadow-&gt;cached_name } ) {</div>
<div class="line">                <span class="keywordflow">if</span>(my $report_entries = $meadow-&gt;get_report_entries_for_time_interval( $our_interval-&gt;{<span class="stringliteral">&#39;min_born&#39;</span>}, $our_interval-&gt;{<span class="stringliteral">&#39;max_died&#39;</span>}, $username ) ) {</div>
<div class="line">                    $queen-&gt;store_resource_usage( $report_entries, $meadow_2_pid_wid-&gt;{$meadow-&gt;type}{$meadow-&gt;cached_name} );</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                warn <span class="stringliteral">&quot;\tNothing new to store for Meadow &quot;</span>.$meadow-&gt;signature.<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my ($url, $reg_conf, $reg_type, $reg_alias, $nosqlvc);                   # Connection parameters</div>
<div class="line">    my ($resource_class_id, $resource_class_name, $analyses_pattern, $analysis_id, $logic_name, $job_id, $force);  # Task specification parameters</div>
<div class="line">    my ($job_limit, $life_span, $no_cleanup, $no_write, $hive_log_dir, $worker_log_dir, $retry_throwing_jobs, $can_respecialize);   # Worker control parameters</div>
<div class="line">    my ($help, $report_versions, $debug);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line"></div>
<div class="line">    # Connection parameters:</div>
<div class="line">               <span class="stringliteral">&#39;url=s&#39;</span>                      =&gt; \$url,</div>
<div class="line">               <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span>         =&gt; \$reg_conf,</div>
<div class="line">               <span class="stringliteral">&#39;reg_type=s&#39;</span>                 =&gt; \$reg_type,</div>
<div class="line">               <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>        =&gt; \$reg_alias,</div>
<div class="line">               <span class="stringliteral">&#39;nosqlvc=i&#39;</span>                  =&gt; \$nosqlvc,       # can<span class="stringliteral">&#39;t use the binary &quot;!&quot; as it is a propagated option</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    # Task specification parameters:</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>rc_id=i<span class="stringliteral">&#39;                    =&gt; \$resource_class_id,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>rc_name=s<span class="stringliteral">&#39;                  =&gt; \$resource_class_name,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>analyses_pattern=s<span class="stringliteral">&#39;         =&gt; \$analyses_pattern,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>analysis_id=i<span class="stringliteral">&#39;              =&gt; \$analysis_id,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>logic_name=s<span class="stringliteral">&#39;               =&gt; \$logic_name,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>job_id=i<span class="stringliteral">&#39;                   =&gt; \$job_id,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>force=i<span class="stringliteral">&#39;                    =&gt; \$force,</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    # Worker control parameters:</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>job_limit=i<span class="stringliteral">&#39;                =&gt; \$job_limit,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>life_span|lifespan=i<span class="stringliteral">&#39;       =&gt; \$life_span,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>no_cleanup<span class="stringliteral">&#39;                 =&gt; \$no_cleanup,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>no_write<span class="stringliteral">&#39;                   =&gt; \$no_write,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>hive_log_dir|hive_output_dir=s<span class="stringliteral">&#39;         =&gt; \$hive_log_dir,       # keep compatibility with the old name</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>worker_log_dir|worker_output_dir=s<span class="stringliteral">&#39;     =&gt; \$worker_log_dir,     # will take precedence over hive_log_dir if set</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>retry_throwing_jobs=i<span class="stringliteral">&#39;      =&gt; \$retry_throwing_jobs,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>can_respecialize=i<span class="stringliteral">&#39;         =&gt; \$can_respecialize,</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    # Other commands</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>h|help<span class="stringliteral">&#39;                     =&gt; \$help,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>v|versions<span class="stringliteral">&#39;                 =&gt; \$report_versions,</span></div>
<div class="line"><span class="stringliteral">               &#39;</span>debug=i<span class="stringliteral">&#39;                    =&gt; \$debug,</span></div>
<div class="line"><span class="stringliteral">    );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if ($help) { script_usage(0); }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($report_versions) {</span></div>
<div class="line"><span class="stringliteral">        report_versions();</span></div>
<div class="line"><span class="stringliteral">        exit(0);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $hive_dba;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    if($url or $reg_alias) {</span></div>
<div class="line"><span class="stringliteral">            # Perform environment variable substitution separately with and without curly braces.</span></div>
<div class="line"><span class="stringliteral">            #       Fixme: Perl 5.10 has a cute new &quot;branch reset&quot; (?|pattern)</span></div>
<div class="line"><span class="stringliteral">            #              that would allow to merge the two substitutions below into a nice one-liner.</span></div>
<div class="line"><span class="stringliteral">            #              But people around may still be using Perl 5.8, so let&#39;</span>s wait a bit.</div>
<div class="line">            #</div>
<div class="line">            # Make sure expressions stay as they were <span class="keywordflow">if</span> we were unable to substitute them.</div>
<div class="line">            #</div>
<div class="line">        <span class="keywordflow">if</span>($url) {</div>
<div class="line">            $url =~ s/\$(\{(\w+)\})/defined($ENV{$2})?<span class="stringliteral">&quot;$ENV{$2}&quot;</span>:<span class="stringliteral">&quot;\$$1&quot;</span>/eg;</div>
<div class="line">            $url =~ s/\$((\w+))/defined($ENV{$2})?<span class="stringliteral">&quot;$ENV{$2}&quot;</span>:<span class="stringliteral">&quot;\$$1&quot;</span>/eg;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        $hive_dba = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">                -url                            =&gt; $url,</div>
<div class="line">                -reg_conf                       =&gt; $reg_conf,</div>
<div class="line">                -reg_type                       =&gt; $reg_type,</div>
<div class="line">                -reg_alias                      =&gt; $reg_alias,</div>
<div class="line">                -no_sql_schema_version_check    =&gt; $nosqlvc,</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        print <span class="stringliteral">&quot;\nERROR : Connection parameters (url or reg_conf+reg_alias) need to be specified\n\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    unless($hive_dba and $hive_dba-&gt;isa(<span class="stringliteral">&quot;Bio::EnsEMBL::Hive::DBSQL::DBAdaptor&quot;</span>)) {</div>
<div class="line">        print <span class="stringliteral">&quot;ERROR : no database connection\n\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( $logic_name ) {</div>
<div class="line">        warn <span class="stringliteral">&quot;-logic_name is now deprecated, please use -analyses_pattern that extends the functionality of -logic_name and -analysis_id .\n&quot;</span>;</div>
<div class="line">        $analyses_pattern = $logic_name;</div>
<div class="line">    } elsif ( $analysis_id ) {</div>
<div class="line">        warn <span class="stringliteral">&quot;-analysis_id is now deprecated, please use -analyses_pattern that extends the functionality of -analysis_id and -logic_name .\n&quot;</span>;</div>
<div class="line">        $analyses_pattern = $analysis_id;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my %specialization_options = (</div>
<div class="line">        resource_class_id   =&gt; $resource_class_id,</div>
<div class="line">        resource_class_name =&gt; $resource_class_name,</div>
<div class="line">        can_respecialize    =&gt; $can_respecialize,</div>
<div class="line">        analyses_pattern    =&gt; $analyses_pattern,</div>
<div class="line">        job_id              =&gt; $job_id,</div>
<div class="line">        force               =&gt; $force,</div>
<div class="line">    );</div>
<div class="line">    my %life_options = (</div>
<div class="line">        job_limit           =&gt; $job_limit,</div>
<div class="line">        life_span           =&gt; $life_span,</div>
<div class="line">        retry_throwing_jobs =&gt; $retry_throwing_jobs,</div>
<div class="line">    );</div>
<div class="line">    my %execution_options = (</div>
<div class="line">        no_cleanup          =&gt; $no_cleanup,</div>
<div class="line">        no_write            =&gt; $no_write,</div>
<div class="line">        worker_log_dir      =&gt; $worker_log_dir,</div>
<div class="line">        hive_log_dir        =&gt; $hive_log_dir,</div>
<div class="line">        debug               =&gt; $debug,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scripts_1_1_run_worker.html#ab18652111ead2fcde6332f271e47237f">Bio::EnsEMBL::Hive::Scripts::RunWorker::runWorker</a>($hive_dba, \%specialization_options, \%life_options, \%execution_options);</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my ($url, $reg_conf, $reg_type, $reg_alias, $nosqlvc, $analysis_id, $logic_name, $input_id);</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">                # connect to the database:</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>                      =&gt; \$url,</div>
<div class="line">            <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span>         =&gt; \$reg_conf,</div>
<div class="line">            <span class="stringliteral">&#39;reg_type=s&#39;</span>                 =&gt; \$reg_type,</div>
<div class="line">            <span class="stringliteral">&#39;reg_alias|regname=s&#39;</span>        =&gt; \$reg_alias,</div>
<div class="line">            <span class="stringliteral">&#39;nosqlvc=i&#39;</span>                  =&gt; \$nosqlvc,      # <span class="keyword">using</span> <span class="stringliteral">&quot;=i&quot;</span> instead of <span class="stringliteral">&quot;!&quot;</span> <span class="keywordflow">for</span> consistency with scripts where it is a propagated option</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                # identify the analysis:</div>
<div class="line">            <span class="stringliteral">&#39;analysis_id=i&#39;</span>         =&gt; \$analysis_id,</div>
<div class="line">            <span class="stringliteral">&#39;logic_name=s&#39;</span>          =&gt; \$logic_name,</div>
<div class="line"></div>
<div class="line">                # specify the input_id (as a <span class="keywordtype">string</span>):</div>
<div class="line">            <span class="stringliteral">&#39;input_id=s&#39;</span>            =&gt; \$input_id,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my $hive_dba;</div>
<div class="line">    <span class="keywordflow">if</span>($url or $reg_alias) {</div>
<div class="line">        $hive_dba = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html">Bio::EnsEMBL::Hive::DBSQL::DBAdaptor</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_adaptor.html#abf2b541c5d7e3b124323a34356e3ace6">new</a>(</div>
<div class="line">                -url                            =&gt; $url,</div>
<div class="line">                -reg_conf                       =&gt; $reg_conf,</div>
<div class="line">                -reg_type                       =&gt; $reg_type,</div>
<div class="line">                -reg_alias                      =&gt; $reg_alias,</div>
<div class="line">                -no_sql_schema_version_check    =&gt; $nosqlvc,</div>
<div class="line">        );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;\nERROR: Connection parameters (url or reg_conf+reg_alias) need to be specified\n&quot;</span>;</div>
<div class="line">        script_usage(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $analysis_adaptor = $hive_dba-&gt;get_AnalysisAdaptor;</div>
<div class="line">    my $analysis; </div>
<div class="line">    <span class="keywordflow">if</span>($logic_name) {</div>
<div class="line">        $analysis = $analysis_adaptor-&gt;fetch_by_logic_name( $logic_name )</div>
<div class="line">            or die <span class="stringliteral">&quot;Could not fetch analysis &#39;$logic_name&#39;&quot;</span>;</div>
<div class="line">    } elsif($analysis_id) {</div>
<div class="line">        $analysis = $analysis_adaptor-&gt;fetch_by_dbID( $analysis_id )</div>
<div class="line">            or die <span class="stringliteral">&quot;Could not fetch analysis with dbID=&#39;$analysis_id&#39;&quot;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code" href="seed__pipeline_8pl.html#ae56eff1c83733ae5dcc4d7f7d6d25ff8">show_seedable_analyses</a>($hive_dba);</div>
<div class="line">        exit(0);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    unless($input_id) {</div>
<div class="line">        $input_id = <span class="stringliteral">&#39;{}&#39;</span>;</div>
<div class="line">        warn <span class="stringliteral">&quot;Since -input_id has not been set, assuming input_id=&#39;$input_id&#39;\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $job = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_analysis_job.html">Bio::EnsEMBL::Hive::AnalysisJob</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_storable.html#a52efcf0d0755525a7bc059b68442c620">new</a>(</div>
<div class="line">        <span class="stringliteral">&#39;prev_job&#39;</span>      =&gt; undef,   # <span class="keyword">this</span> job has been created by the initialization script, not by another job</div>
<div class="line">        <span class="stringliteral">&#39;analysis&#39;</span>      =&gt; $analysis,</div>
<div class="line">        <span class="stringliteral">&#39;input_id&#39;</span>      =&gt; destringify( $input_id ),    # Make sure all job creations undergo re-stringification to avoid alternative <span class="stringliteral">&quot;spellings&quot;</span> of the same input_id hash</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my ($job_id) = @{ $hive_dba-&gt;get_AnalysisJobAdaptor-&gt;store_jobs_and_adjust_counters( [ $job ] ) };</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($job_id) {</div>
<div class="line"></div>
<div class="line">        print <span class="stringliteral">&quot;Job $job_id [ &quot;</span>.$analysis-&gt;logic_name.<span class="charliteral">&#39;(&#39;</span>.$analysis-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_storable.html#a5e5743dee1414d2c0dec45b5a5d42216">dbID</a>.<span class="stringliteral">&quot;)] : &#39;$input_id&#39;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">        warn <span class="stringliteral">&quot;Could not create job &#39;$input_id&#39; (it may have been created already)\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my ($reg_conf, $help, $debug, $no_write, $no_cleanup, $flow_into, $input_id, $language);</div>
<div class="line"></div>
<div class="line">    my $module_or_file = shift @ARGV or script_usage();</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">               <span class="stringliteral">&#39;help&#39;</span>               =&gt; \$help,</div>
<div class="line">               <span class="stringliteral">&#39;debug=i&#39;</span>            =&gt; \$debug,</div>
<div class="line">               <span class="stringliteral">&#39;reg_conf|regfile=s&#39;</span> =&gt; \$reg_conf,</div>
<div class="line">               <span class="stringliteral">&#39;no_write&#39;</span>           =&gt; \$no_write,</div>
<div class="line">               <span class="stringliteral">&#39;no_cleanup&#39;</span>         =&gt; \$no_cleanup,</div>
<div class="line">               <span class="stringliteral">&#39;flow_into|flow=s&#39;</span>   =&gt; \$flow_into,</div>
<div class="line">               <span class="stringliteral">&#39;input_id=s&#39;</span>         =&gt; \$input_id,</div>
<div class="line">               <span class="stringliteral">&#39;language=s&#39;</span>         =&gt; \$language,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($help or !$module_or_file) {</div>
<div class="line">        script_usage(0);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($reg_conf) {</div>
<div class="line">        require Bio::EnsEMBL::Registry;</div>
<div class="line">        Bio::EnsEMBL::Registry-&gt;load_all($reg_conf);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    unless($input_id) {</div>
<div class="line">        my ($param_hash, $param_list) = parse_cmdline_options();</div>
<div class="line">        $input_id = stringify($param_hash);</div>
<div class="line">    }</div>
<div class="line">    warn <span class="stringliteral">&quot;\nRunning &#39;$module_or_file&#39; with input_id=&#39;$input_id&#39; :\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    my %flags = (</div>
<div class="line">        no_write    =&gt; $no_write,</div>
<div class="line">        no_cleanup  =&gt; $no_cleanup,</div>
<div class="line">        debug       =&gt; $debug,</div>
<div class="line">    );</div>
<div class="line">    my $job_successful = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scripts_1_1_standalone_job.html#aebb03c207ffdd2934466700684041aed">Bio::EnsEMBL::Hive::Scripts::StandaloneJob::standaloneJob</a>($module_or_file, $input_id, \%flags, $flow_into, $language);</div>
<div class="line">    exit(1) unless $job_successful;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><p>Undocumented method</p>
<div id="codesection-main" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-main-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-main-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-main-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#a3ce8b237b3bdb2817dac6f769e5768c2">main</a> {</div>
<div class="line">    my $url;</div>
<div class="line"></div>
<div class="line">    GetOptions(</div>
<div class="line">            <span class="stringliteral">&#39;url=s&#39;</span>             =&gt; \$url,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>($url) {</div>
<div class="line">        my $dbc = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_connection.html">Bio::EnsEMBL::Hive::DBSQL::DBConnection</a>-&gt;<a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_d_b_s_q_l_1_1_d_b_connection.html#a7931542229862db93f899aef0eb983f0">new</a>( -url =&gt; $url )</div>
<div class="line">            || die <span class="stringliteral">&quot;Could not parse URL &#39;$url&#39;&quot;</span>;</div>
<div class="line"></div>
<div class="line">        my $sql = <span class="stringliteral">&quot;UPDATE hive_meta SET meta_value=63 WHERE meta_key=&#39;hive_sql_schema_version&#39; AND meta_value=&#39;62&#39;&quot;</span>;</div>
<div class="line">        my $sth = $dbc-&gt;do( $sql );</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        die <span class="stringliteral">&quot;Please provide -url parameter to this patch script&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
<a class="anchor" id="af314298b28a69538fb25aa7eb1327c98"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public run_autonomously </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented method</p>
<div id="codesection-run_autonomously" class="dynheader closed" style="cursor:pointer;" onclick="return toggleVisibility(this)">  
    <img id='codesection-run_autonomously-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_autonomously-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_autonomously-content' class='dyncontent' style='display: none;'> 
 <div class="fragment"><div class="line">sub <a class="code" href="beekeeper_8pl.html#af314298b28a69538fb25aa7eb1327c98">run_autonomously</a> {</div>
<div class="line">    my ($self, $max_loops, $keep_alive, $queen, $valley, $list_of_analyses, $analyses_pattern, $run_job_id, $force) = @_;</div>
<div class="line"></div>
<div class="line">    my $resourceless_worker_cmd = <a class="code" href="beekeeper_8pl.html#ad7de8680eb8b39e160cee04957ccd668">generate_worker_cmd</a>($self, $analyses_pattern, $run_job_id, $force);</div>
<div class="line"></div>
<div class="line">    my $beekeeper_pid = $$;</div>
<div class="line"></div>
<div class="line">    my $iteration=0;</div>
<div class="line">    my $reasons_to_exit;</div>
<div class="line"></div>
<div class="line">    BKLOOP: <span class="keywordflow">while</span>( ($iteration++ != $max_loops) or $keep_alive ) {  # NB: the order of conditions is important!</div>
<div class="line"></div>
<div class="line">        print(<span class="stringliteral">&quot;\nBeekeeper : loop #$iteration ======================================================\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">        $queen-&gt;check_for_dead_workers($valley, 0);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( $reasons_to_exit = $queen-&gt;print_status_and_return_reasons_to_exit( $list_of_analyses, !$self-&gt;{<span class="stringliteral">&#39;no_analysis_stats&#39;</span>} )) {</div>
<div class="line">            <span class="keywordflow">if</span>($keep_alive) {</div>
<div class="line">                print <span class="stringliteral">&quot;Beekeeper : detected exit condition, but staying alive because of -keep_alive : &quot;</span>.$reasons_to_exit;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                last BKLOOP;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_RoleAdaptor-&gt;print_active_role_counts;</div>
<div class="line"></div>
<div class="line">        my $workers_to_submit_by_meadow_type_rc_name</div>
<div class="line">            = <a class="code" href="class_bio_1_1_ens_e_m_b_l_1_1_hive_1_1_scheduler.html#a65f7b429d0ffbda238faeda2451350a8">Bio::EnsEMBL::Hive::Scheduler::schedule_workers_resync_if_necessary</a>($queen, $valley, $list_of_analyses);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( keys %$workers_to_submit_by_meadow_type_rc_name ) {</div>
<div class="line"></div>
<div class="line">            my $submit_log_subdir;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>( $self-&gt;{<span class="stringliteral">&#39;submit_log_dir&#39;</span>} ) {</div>
<div class="line">                $submit_log_subdir = $self-&gt;{<span class="stringliteral">&#39;submit_log_dir&#39;</span>}.<span class="stringliteral">&quot;/submit_bk${beekeeper_pid}_iter${iteration}&quot;</span>;</div>
<div class="line">                make_path( $submit_log_subdir );</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">                # make sure the Resources are loaded fresh every time we need them:</span></div>
<div class="line"><span class="preprocessor"></span>            my $rc_id2name  = $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_ResourceClassAdaptor-&gt;fetch_HASHED_FROM_resource_class_id_TO_name();</div>
<div class="line">            my %meadow_type_rc_name2resource_param_list = ();</div>
<div class="line">            <span class="keywordflow">foreach</span> my $rd (@{ $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_ResourceDescriptionAdaptor-&gt;fetch_all() }) {</div>
<div class="line">                $meadow_type_rc_name2resource_param_list{ $rd-&gt;meadow_type() }{ $rc_id2name-&gt;{$rd-&gt;resource_class_id} } = [ $rd-&gt;submission_cmd_args, $rd-&gt;worker_cmd_args ];</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">foreach</span> my $meadow_type (keys %$workers_to_submit_by_meadow_type_rc_name) {</div>
<div class="line"></div>
<div class="line">                my $this_meadow = $valley-&gt;available_meadow_hash-&gt;{$meadow_type};</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">foreach</span> my $rc_name (keys %{ $workers_to_submit_by_meadow_type_rc_name-&gt;{$meadow_type} }) {</div>
<div class="line">                    my $this_meadow_rc_worker_count = $workers_to_submit_by_meadow_type_rc_name-&gt;{$meadow_type}{$rc_name};</div>
<div class="line"></div>
<div class="line">                    print <span class="stringliteral">&quot;\nBeekeeper : submitting $this_meadow_rc_worker_count workers (rc_name=$rc_name) to &quot;</span>.$this_meadow-&gt;signature().<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">                    my ($submission_cmd_args, $worker_cmd_args) = @{ $meadow_type_rc_name2resource_param_list{ $meadow_type }{ $rc_name } || [] };</div>
<div class="line"></div>
<div class="line">                    my $specific_worker_cmd = $resourceless_worker_cmd</div>
<div class="line">                                            . <span class="stringliteral">&quot; -rc_name $rc_name&quot;</span></div>
<div class="line">                                            . (defined($worker_cmd_args) ? <span class="stringliteral">&quot; $worker_cmd_args&quot;</span> : <span class="stringliteral">&#39;&#39;</span>);</div>
<div class="line"></div>
<div class="line">                    $this_meadow-&gt;submit_workers($specific_worker_cmd, $this_meadow_rc_worker_count, $iteration,</div>
<div class="line">                                                    $rc_name, $submission_cmd_args || <span class="stringliteral">&#39;&#39;</span>, $submit_log_subdir);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            print <span class="stringliteral">&quot;\nBeekeeper : not submitting any workers this iteration\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( $iteration != $max_loops ) {    # skip the last sleep</div>
<div class="line">            $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;dbc-&gt;disconnect_if_idle;</div>
<div class="line">            printf(<span class="stringliteral">&quot;Beekeeper : going to sleep for %.2f minute(s). Expect next iteration at %s\n&quot;</span>, $self-&gt;{<span class="stringliteral">&#39;sleep_minutes&#39;</span>}, scalar localtime(time+$self-&gt;{<span class="stringliteral">&#39;sleep_minutes&#39;</span>}*60));</div>
<div class="line">            sleep($self-&gt;{<span class="stringliteral">&#39;sleep_minutes&#39;</span>}*60);  </div>
<div class="line"></div>
<div class="line">            unless($run_job_id) {   # refresh the data from analysis_base table</div>
<div class="line">                $list_of_analyses = $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;get_AnalysisAdaptor-&gt;fetch_all_by_pattern( $analyses_pattern );</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    print <span class="stringliteral">&quot;Beekeeper : stopped looping because &quot;</span>.( $reasons_to_exit || <span class="stringliteral">&quot;the number of loops was limited by $max_loops and this limit expired\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Beekeeper: dbc %d disconnect cycles\n&quot;</span>, $self-&gt;{<span class="stringliteral">&#39;dba&#39;</span>}-&gt;dbc-&gt;disconnect_count);</div>
<div class="line">}</div>
</div><!-- fragment --> </div> 
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_3eba02bba8db0756280349dc5308b6d9.html">scripts</a></li><li class="navelem"><a class="el" href="beekeeper_8pl.html">beekeeper.pl</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
