branches:
  only:
  - main
  - /^version.*$/

language: perl

dist:
  - focal

services:
  - mysql
  - postgresql

perl:
  - '5.26'
  - '5.32'

env:
  - EHIVE_TEST_PIPELINE_URLS='mysql://travis@127.0.0.1/'
  - EHIVE_TEST_PIPELINE_URLS='pgsql://postgres@127.0.0.1/'
  - EHIVE_TEST_PIPELINE_URLS='sqlite:///'

addons:
  apt:
    packages:
    - graphviz

# Dependencies that are brought by a system smart enough to reuse existing
# files (e.g. CPAN) are cached between builds under $HOME/deps.
# Other dependencies are under $PWD/deps and *not* cached.
cache:
  directories:
    - $HOME/deps

before_install:
    - cpanm -nq local::lib
    - eval "$(perl -Mlocal::lib=${HOME}/deps)"
    - mkdir deps
    - cd deps
    - git clone --branch main --depth 1 https://github.com/Ensembl/ensembl
    - export PERL5LIB=$PWD/ensembl/modules:$PERL5LIB
    - git clone --branch v1.6.x --depth 1 https://github.com/bioperl/bioperl-live
    - export PERL5LIB=$PWD/bioperl-live:$PERL5LIB
    - cd ..
    - export PERL5LIB=$PWD/modules:$PERL5LIB

install:
    - cpanm -n --installdeps --with-recommends .
    - cpanm -n --installdeps --cpanfile deps/ensembl/cpanfile .
    - cpanm -n Devel::Cover::Report::Coveralls Devel::Cover::Report::Codecov
  - mysql -u root -h localhost -e 'GRANT ALL PRIVILEGES ON *.* TO "travis"@"%"'
  - mysql -u root -h localhost -e 'SET GLOBAL local_infile=1'

script: "./scripts/dev/travis_run_tests.sh"

notifications:
  email:
    on_success: always
    on_failure: always
  slack:
    rooms:
      # coregithub
      - secure: gL6s4PRts/S293qOTVDFub8i7DWxqXVpDz5il8Vx7LxSYgOiA9AJcbT1zuXxhfONA5RwXJ62gRze0LllDcAS9TiUl199SSq7x+hBMBKzGxWV5I0P6m5aPMRi2vdC4yiATMQYF97PaH3zWobEDiGEHRAS+mkGNBExXY1hwZSasy8=
      # ehive-commits
      - secure: XUShBwss607RlWDQyn4tkVDX390+aIXv1ntaUzr9MtsXMpCNm5X/7PPle7Cq6FZ57vHzkIOM0+FM3kIou7vbc3ediwHEv9/o8PwDah7xH46/ukjCsI+labR6jxoX8YX9SRvUUm4FV9Vo2gkWi0IYM+k+VI6AyDFyhEzyJOIGHEY=
    on_failure: change
